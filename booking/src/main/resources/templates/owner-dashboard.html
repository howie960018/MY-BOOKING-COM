<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿æ±ç®¡ç†é¢æ¿ - è¨‚æˆ¿ç³»çµ±</title>
    <link rel="stylesheet" href="/css/style.css">
    <!-- åŠ å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            margin: 0;
            color: #666;
            font-size: 1rem;
        }
        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .action-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .action-card:hover {
            transform: translateY(-5px);
        }
        .action-card a {
            text-decoration: none;
            color: inherit;
        }
        .action-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .action-card p {
            color: #666;
            margin: 0;
        }
        .icon {
            font-size: 2rem;
            margin-bottom: 15px;
        }
        header {
            background: #007bff;
            color: white;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        header nav {
            margin-top: 1rem;
        }
        header nav a {
            color: white;
            text-decoration: none;
            margin-right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        header nav a:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .logout-btn {
            background-color: rgba(255,255,255,0.2);
        }
        .logout-btn:hover {
            background-color: rgba(255,255,255,0.3);
        }
        /* æ–°å¢ï¼šåœ–è¡¨å€åŸŸæ¨£å¼ */
        .charts-section {
            margin-top: 40px;
        }
        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chart-card h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.2rem;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <header>
        <h1>æˆ¿æ±ç®¡ç†é¢æ¿</h1>
        <nav>
            <a href="/">é¦–é </a>
            <a href="/owner-accommodations">ç®¡ç†ä½å®¿</a>
            <a href="/owner-bookings">ç®¡ç†è¨‚å–®</a>
            <form action="/logout" method="POST" style="display: inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="logout-btn" style="background: none; border: none; color: white; cursor: pointer; padding: 0.5rem 1rem;">ç™»å‡º</button>
            </form>
        </nav>
    </header>

    <main class="dashboard-container">
        <section class="stats-grid">
            <div class="stat-card">
                <h3>æˆ‘çš„ä½å®¿</h3>
                <div class="number" id="accommodation-count">-</div>
            </div>
            <div class="stat-card">
                <h3>ç¸½æˆ¿å‹æ•¸</h3>
                <div class="number" id="room-type-count">-</div>
            </div>
            <div class="stat-card">
                <h3>å¾…ç¢ºèªè¨‚å–®</h3>
                <div class="number" id="pending-bookings">-</div>
            </div>
            <div class="stat-card">
                <h3>æœ¬æœˆç‡Ÿæ”¶</h3>
                <div class="number" id="monthly-revenue">-</div>
            </div>
        </section>

        <section class="action-cards">
            <div class="action-card">
                <a href="/owner-accommodations">
                    <div class="icon">ğŸ </div>
                    <h3>ç®¡ç†æˆ‘çš„ä½å®¿</h3>
                    <p>æ–°å¢ã€ç·¨è¼¯æˆ–åˆªé™¤ä½å®¿è³‡è¨Š</p>
                </a>
            </div>
            <div class="action-card">
                <a href="/owner-bookings">
                    <div class="icon">ğŸ“‹</div>
                    <h3>ç®¡ç†è¨‚å–®</h3>
                    <p>æŸ¥çœ‹å’Œè™•ç†è¨‚å–®è«‹æ±‚</p>
                </a>
            </div>
            <div class="action-card">
                <a href="javascript:void(0)" onclick="exportOwnerRevenue()">
                    <div class="icon">ğŸ“Š</div>
                    <h3>ç‡Ÿæ”¶å ±è¡¨</h3>
                    <p>ä¸‹è¼‰ Excel æ ¼å¼çš„ç‡Ÿæ”¶çµ±è¨ˆå ±è¡¨</p>
                </a>
            </div>
        </section>

        <!-- æ–°å¢ï¼šåœ–è¡¨åˆ†æå€åŸŸ -->
        <section class="charts-section">
            <h2 style="color: #333; margin-bottom: 20px;">ğŸ“Š ç‡Ÿé‹æ•¸æ“šåˆ†æ</h2>

            <!-- ç¬¬ä¸€æ’ï¼šä½å®¿ç‡Ÿæ”¶ä½”æ¯” + è¨‚å–®ç‹€æ…‹ -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>ğŸ  ä½å®¿ç‡Ÿæ”¶ä½”æ¯”</h3>
                    <div class="chart-container">
                        <canvas id="accommodationRevenueChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ğŸ“‹ æœ¬æœˆè¨‚å–®ç‹€æ…‹</h3>
                    <div class="chart-container">
                        <canvas id="orderStatusChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ç¬¬äºŒæ’ï¼šæˆ¿å‹éŠ·å”®æ’è¡Œ + å…¥ä½ç‡è¶¨å‹¢ -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>ğŸ›ï¸ æˆ¿å‹éŠ·å”®æ’è¡Œ</h3>
                    <div class="chart-container">
                        <canvas id="roomTypeSalesChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ğŸ“ˆ è¿‘ 30 å¤©å…¥ä½ç‡è¶¨å‹¢</h3>
                    <div class="chart-container">
                        <canvas id="occupancyRateChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // å…¨åŸŸè®Šæ•¸å„²å­˜åœ–è¡¨å¯¦ä¾‹
        let accommodationRevenueChart = null;
        let orderStatusChart = null;
        let roomTypeSalesChart = null;
        let occupancyRateChart = null;

        // è¼‰å…¥çµ±è¨ˆè³‡æ–™
        async function loadStats() {
            try {
                // è¼‰å…¥åŸæœ‰çš„çµ±è¨ˆå¡ç‰‡è³‡æ–™
                await loadStatsCards();

                // è¼‰å…¥åœ–è¡¨è³‡æ–™
                await loadChartData();

            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥çµ±è¨ˆå¡ç‰‡è³‡æ–™ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰
        async function loadStatsCards() {
            try {
                // è¼‰å…¥ä½å®¿è³‡æ–™
                const accResponse = await fetch('/api/owner/accommodations');
                if (accResponse.ok) {
                    const accommodations = await accResponse.json();
                    document.getElementById('accommodation-count').textContent = accommodations.length;

                    // è¨ˆç®—ç¸½æˆ¿å‹æ•¸
                    let roomTypeCount = accommodations.reduce((total, acc) =>
                        total + (acc.roomTypes ? acc.roomTypes.length : 0), 0);
                    document.getElementById('room-type-count').textContent = roomTypeCount;
                }

                // è¼‰å…¥è¨‚å–®è³‡æ–™
                const bookingResponse = await fetch('/api/bookings');
                if (bookingResponse.ok) {
                    const bookings = await bookingResponse.json();

                    // è¨ˆç®—å¾…ç¢ºèªè¨‚å–®
                    const pendingCount = bookings.filter(b => !b.status || b.status === 'PENDING').length;
                    document.getElementById('pending-bookings').textContent = pendingCount;

                    // è¨ˆç®—æœ¬æœˆç‡Ÿæ”¶
                    const currentMonth = new Date().getMonth();
                    const monthlyRevenue = bookings
                        .filter(b => b.status === 'CONFIRMED' && new Date(b.checkIn).getMonth() === currentMonth)
                        .reduce((total, b) => total + b.totalPrice, 0);
                    document.getElementById('monthly-revenue').textContent =
                        'NT$ ' + monthlyRevenue.toLocaleString();
                }
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆå¡ç‰‡å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥åœ–è¡¨è³‡æ–™
        async function loadChartData() {
            try {
                console.log('é–‹å§‹è¼‰å…¥åœ–è¡¨è³‡æ–™...');

                // ä¸€æ¬¡æ€§å–å¾—æ‰€æœ‰åœ–è¡¨è³‡æ–™
                const response = await fetch('/api/statistics/owner/dashboard');
                if (!response.ok) {
                    throw new Error('è¼‰å…¥åœ–è¡¨è³‡æ–™å¤±æ•—');
                }

                const data = await response.json();
                console.log('åœ–è¡¨è³‡æ–™è¼‰å…¥æˆåŠŸ:', data);

                // æ¸²æŸ“å„å€‹åœ–è¡¨
                renderAccommodationRevenueChart(data.accommodationRevenue);
                renderOrderStatusChart(data.orderStatus);
                renderRoomTypeSalesChart(data.roomTypeSales);
                renderOccupancyRateChart(data.occupancyRate);

            } catch (error) {
                console.error('è¼‰å…¥åœ–è¡¨è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);

                // é¡¯ç¤ºå‹å–„çš„éŒ¯èª¤è¨Šæ¯
                const chartSections = document.querySelectorAll('.chart-container canvas');
                chartSections.forEach(canvas => {
                    const parent = canvas.parentElement;
                    parent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <p style="font-size: 1.2rem; margin: 0;">ğŸ“Š</p>
                            <p style="margin-top: 10px;">åœ–è¡¨è¼‰å…¥å¤±æ•—</p>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="location.reload()">
                                é‡æ–°è¼‰å…¥
                            </button>
                        </div>
                    `;
                });
            }
        }

        // 1. æ¸²æŸ“ä½å®¿ç‡Ÿæ”¶ä½”æ¯”åœ“é¤…åœ–
        function renderAccommodationRevenueChart(data) {
            const ctx = document.getElementById('accommodationRevenueChart');
            if (!ctx) return;

            if (accommodationRevenueChart) {
                accommodationRevenueChart.destroy();
            }

            const labels = data.map(item => item.name);
            const revenues = data.map(item => item.revenue);

            // ç”Ÿæˆæ¼¸å±¤è‰²å½©
            const colors = [
                'rgba(13, 110, 253, 0.8)',
                'rgba(25, 135, 84, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(220, 53, 69, 0.8)',
                'rgba(108, 117, 125, 0.8)'
            ];

            accommodationRevenueChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: revenues,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: colors.slice(0, labels.length).map(c => c.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 12 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: NT$ ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 2. æ¸²æŸ“è¨‚å–®ç‹€æ…‹ç”œç”œåœˆåœ–
        function renderOrderStatusChart(data) {
            const ctx = document.getElementById('orderStatusChart');
            if (!ctx) return;

            if (orderStatusChart) {
                orderStatusChart.destroy();
            }

            orderStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å¾…ç¢ºèª', 'å·²ç¢ºèª', 'å·²å–æ¶ˆ'],
                    datasets: [{
                        data: [
                            data.PENDING || 0,
                            data.CONFIRMED || 0,
                            data.CANCELLED || 0
                        ],
                        backgroundColor: [
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 193, 7, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%', // ç”œç”œåœˆæ•ˆæœ
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 12 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} ç­† (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 3. æ¸²æŸ“æˆ¿å‹éŠ·å”®æ’è¡Œæ©«æ¢åœ–
        function renderRoomTypeSalesChart(data) {
            const ctx = document.getElementById('roomTypeSalesChart');
            if (!ctx) return;

            if (roomTypeSalesChart) {
                roomTypeSalesChart.destroy();
            }

            // åªå–å‰ 10 å
            const topData = data.slice(0, 10);
            const labels = topData.map(item => item.name);
            const counts = topData.map(item => item.count);

            roomTypeSalesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è¨‚å–®æ•¸é‡',
                        data: counts,
                        backgroundColor: 'rgba(13, 110, 253, 0.8)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y', // æ©«å‘é¡¯ç¤º
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `è¨‚å–®æ•¸: ${context.parsed.x} ç­†`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'è¨‚å–®æ•¸é‡'
                            }
                        }
                    }
                }
            });
        }

        // 4. æ¸²æŸ“å…¥ä½ç‡è¶¨å‹¢é¢ç©åœ–
        function renderOccupancyRateChart(data) {
            const ctx = document.getElementById('occupancyRateChart');
            if (!ctx) return;

            if (occupancyRateChart) {
                occupancyRateChart.destroy();
            }

            const dates = data.map(item => item.date);
            const rates = data.map(item => item.rate);

            occupancyRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'å…¥ä½ç‡ (%)',
                        data: rates,
                        borderColor: 'rgba(25, 135, 84, 1)',
                        backgroundColor: 'rgba(25, 135, 84, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `å…¥ä½ç‡: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'å…¥ä½ç‡ (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });
        }

        // åŒ¯å‡ºç‡Ÿæ”¶å ±è¡¨ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰
        function exportOwnerRevenue() {
            const url = '/api/export/owner/revenue';
            const link = document.createElement('a');
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('ç‡Ÿæ”¶å ±è¡¨åŒ¯å‡ºä¸­ï¼Œè«‹ç¨å€™...');
        }

        // é é¢è¼‰å…¥æ™‚è¼‰å…¥çµ±è¨ˆè³‡æ–™
        document.addEventListener('DOMContentLoaded', loadStats);
    </script>
</body>
</html>
