<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ç®¡ç† - è¨‚æˆ¿ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .page-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filter-btn {
            margin-right: 5px;
        }
        .filter-btn.active {
            background-color: #0d6efd;
            color: white;
        }
        .status-badge.PENDING {
            background-color: #ffc107;
            color: #000;
        }
        .status-badge.CONFIRMED {
            background-color: #198754;
            color: white;
        }
        .status-badge.CANCELLED {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>

<!-- é»‘åº•å°èˆªæ¬„ -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">ğŸ¨ è¨‚æˆ¿ç³»çµ±</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/owner-dashboard">ğŸ“Š å„€è¡¨æ¿</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/owner-accommodations">ğŸ  ä½å®¿ç®¡ç†</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/owner-bookings">ğŸ“‹ è¨‚å–®ç®¡ç†</a>
                </li>
                <li class="nav-item">
                    <form th:action="@{/logout}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-outline-light btn-sm ms-2">ç™»å‡º</button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- é é¢æ¨™é¡Œå€ -->
<div class="page-header">
    <div class="container">
        <h1 class="mb-2">ğŸ“‹ è¨‚å–®ç®¡ç†</h1>
        <p class="mb-0 opacity-75">æª¢è¦–èˆ‡ç®¡ç†æ‚¨ä½å®¿çš„æ‰€æœ‰è¨‚å–®</p>
    </div>
</div>

<div class="container">
    <!-- å·¥å…·æ¬„ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">ğŸ“Š è¨‚å–®ç¸½è¦½</h4>
        <button class="btn btn-primary" onclick="loadBookings()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
    </div>

    <!-- ç¯©é¸å€åŸŸ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">ğŸ“‹ è¨‚å–®ç¯©é¸</h5>
        </div>
        <div class="card-body">
            <!-- ç‹€æ…‹ç¯©é¸ -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">è¨‚å–®ç‹€æ…‹ï¼š</label>
                    <div class="btn-group" role="group" aria-label="è¨‚å–®ç‹€æ…‹ç¯©é¸">
                        <button class="btn btn-outline-secondary filter-btn active" data-status="all">å…¨éƒ¨</button>
                        <button class="btn btn-outline-warning filter-btn" data-status="PENDING">å¾…ç¢ºèª</button>
                        <button class="btn btn-outline-success filter-btn" data-status="CONFIRMED">å·²ç¢ºèª</button>
                        <button class="btn btn-outline-danger filter-btn" data-status="CANCELLED">å·²å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ—¥æœŸç¯©é¸ -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">æ—¥æœŸç¯„åœç¯©é¸ï¼š</label>
                    <div class="d-flex align-items-center">
                        <input type="date" id="filterStartDate" class="form-control form-control-sm me-2" placeholder="é–‹å§‹æ—¥æœŸ">
                        <span class="me-2">è‡³</span>
                        <input type="date" id="filterEndDate" class="form-control form-control-sm me-2" placeholder="çµæŸæ—¥æœŸ">
                        <button class="btn btn-primary btn-sm" onclick="applyDateFilter()">ç¯©é¸</button>
                        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="clearDateFilter()">æ¸…é™¤</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">åŒ¯å‡ºå ±è¡¨ï¼š</label>
                    <div class="d-flex align-items-center">
                        <input type="date" id="exportStartDate" class="form-control form-control-sm me-2" placeholder="åŒ¯å‡ºé–‹å§‹æ—¥æœŸ">
                        <span class="me-2">è‡³</span>
                        <input type="date" id="exportEndDate" class="form-control form-control-sm me-2" placeholder="åŒ¯å‡ºçµæŸæ—¥æœŸ">
                        <button class="btn btn-success btn-sm" onclick="exportBookings()">ğŸ“¥ åŒ¯å‡º Excel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>å®¢æˆ¶</th>
                <th>æˆ‘çš„ä½å®¿</th>
                <th>æˆ¿å‹</th>
                <th>å…¥ä½</th>
                <th>é€€æˆ¿</th>
                <th>é–“æ•¸</th>
                <th>ç¸½åƒ¹</th>
                <th>ç‹€æ…‹</th>
                <th>å‹•ä½œ</th>
            </tr>
            </thead>
            <tbody id="bookings"></tbody>
        </table>
    </div>
</div>

<script>
    // ç²å– CSRF token
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    // å‰µå»ºé€šç”¨çš„ fetch headers
    const getHeaders = () => {
        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        return headers;
    };

    let currentBookings = []; // å„²å­˜ç•¶å‰è¼‰å…¥çš„è¨‚å–®

    // è™•ç†ç‹€æ…‹æ–‡å­—é¡¯ç¤º
    function getStatusText(status) {
        switch(status) {
            case 'CONFIRMED': return 'å·²ç¢ºèª';
            case 'CANCELLED': return 'å·²å–æ¶ˆ';
            case 'PENDING':
            default: return 'å¾…ç¢ºèª';
        }
    }

    // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
    function displayBookings(bookings, filterStatus = 'all') {
        const tbody = document.getElementById("bookings");
        const filteredBookings = filterStatus === 'all'
            ? bookings
            : bookings.filter(b => (b.status || 'PENDING') === filterStatus);

        tbody.innerHTML = filteredBookings.map(b => {
            const status = b.status || 'PENDING';
            return `
                <tr data-status="${status}">
                    <td>${b.id}</td>
                    <td>${b.user?.username || '-'}</td>
                    <td>${b.roomType?.accommodation?.name || '-'}</td>
                    <td>${b.roomType?.name || '-'}</td>
                    <td>${b.checkIn}</td>
                    <td>${b.checkOut}</td>
                    <td>${b.bookedQuantity}</td>
                    <td class="text-success fw-bold">
                        ${b.totalPrice ? 'NT$ ' + Number(b.totalPrice).toLocaleString() : '-'}
                    </td>
                    <td>
                        <span class="badge status-badge ${status}">
                            ${getStatusText(status)}
                        </span>
                    </td>
                    <td>
                        ${getActionButtons(b)}
                    </td>
                </tr>
            `;
        }).join('');

        if (filteredBookings.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</td>
                </tr>
            `;
        }
    }

    // æ—¥æœŸç¯©é¸åŠŸèƒ½
    function applyDateFilter() {
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;

        if (!startDate && !endDate) {
            alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ—¥æœŸç¯„åœ');
            return;
        }

        let filteredBookings = [...currentBookings];

        // æ ¹æ“šå…¥ä½æ—¥æœŸç¯©é¸
        if (startDate) {
            filteredBookings = filteredBookings.filter(b => b.checkIn >= startDate);
        }
        if (endDate) {
            filteredBookings = filteredBookings.filter(b => b.checkIn <= endDate);
        }

        // å–å¾—ç•¶å‰ç‹€æ…‹ç¯©é¸
        const activeFilter = document.querySelector('.filter-btn.active').dataset.status;
        const statusFilteredBookings = activeFilter === 'all'
            ? filteredBookings
            : filteredBookings.filter(b => (b.status || 'PENDING') === activeFilter);

        // é¡¯ç¤ºç¯©é¸çµæœ
        const tbody = document.getElementById("bookings");
        tbody.innerHTML = statusFilteredBookings.map(b => {
            const status = b.status || 'PENDING';
            return `
                <tr data-status="${status}">
                    <td>${b.id}</td>
                    <td>${b.user?.username || '-'}</td>
                    <td>${b.roomType?.accommodation?.name || '-'}</td>
                    <td>${b.roomType?.name || '-'}</td>
                    <td>${b.checkIn}</td>
                    <td>${b.checkOut}</td>
                    <td>${b.bookedQuantity}</td>
                    <td class="text-success fw-bold">
                        ${b.totalPrice ? 'NT$ ' + Number(b.totalPrice).toLocaleString() : '-'}
                    </td>
                    <td>
                        <span class="badge status-badge ${status}">
                            ${getStatusText(status)}
                        </span>
                    </td>
                    <td>
                        ${getActionButtons(b)}
                    </td>
                </tr>
            `;
        }).join('');

        if (statusFilteredBookings.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è¨‚å–®</td>
                </tr>
            `;
        }

        // æ›´æ–°è¨ˆæ•¸é¡¯ç¤º
        updateFilterInfo(startDate, endDate, statusFilteredBookings.length);
    }

    // æ¸…é™¤æ—¥æœŸç¯©é¸
    function clearDateFilter() {
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';

        // é‡æ–°é¡¯ç¤ºæ‰€æœ‰è¨‚å–®ï¼ˆä¿æŒç‹€æ…‹ç¯©é¸ï¼‰
        const activeFilter = document.querySelector('.filter-btn.active').dataset.status;
        displayBookings(currentBookings, activeFilter);

        // æ¸…é™¤ç¯©é¸è³‡è¨Š
        const filterInfo = document.getElementById('filterInfo');
        if (filterInfo) {
            filterInfo.remove();
        }
    }

    // æ›´æ–°ç¯©é¸è³‡è¨Šé¡¯ç¤º
    function updateFilterInfo(startDate, endDate, count) {
        // ç§»é™¤èˆŠçš„ç¯©é¸è³‡è¨Š
        const oldInfo = document.getElementById('filterInfo');
        if (oldInfo) {
            oldInfo.remove();
        }

        // å»ºç«‹æ–°çš„ç¯©é¸è³‡è¨Š
        const filterInfo = document.createElement('div');
        filterInfo.id = 'filterInfo';
        filterInfo.className = 'alert alert-info mt-3';
        filterInfo.innerHTML = `
            <strong>ğŸ“… æ—¥æœŸç¯©é¸å·²å¥—ç”¨ï¼š</strong>
            ${startDate ? `å¾ ${startDate}` : ''}
            ${startDate && endDate ? ' è‡³ ' : ''}
            ${endDate ? `åˆ° ${endDate}` : ''}
            - æ‰¾åˆ° <strong>${count}</strong> ç­†è¨‚å–®
        `;

        // æ’å…¥åˆ°è¡¨æ ¼å‰
        const tableContainer = document.querySelector('.table-responsive');
        tableContainer.parentNode.insertBefore(filterInfo, tableContainer);
    }

    // ç²å–æ“ä½œæŒ‰éˆ•
    function getActionButtons(booking) {
        const status = booking.status || 'PENDING';
        if (status === 'CANCELLED') return '';

        let buttons = [];
        if (status === 'PENDING') {
            buttons.push(`<button class="btn btn-success btn-sm me-1" onclick="confirmBooking(${booking.id})">ç¢ºèªè¨‚å–®</button>`);
        }
        buttons.push(`<button class="btn btn-danger btn-sm" onclick="cancelBooking(${booking.id})">å–æ¶ˆè¨‚å–®</button>`);
        return buttons.join('');
    }

    // è¼‰å…¥è¨‚å–®
    async function loadBookings() {
        try {
            const res = await fetch("/api/owner/bookings", {
                headers: getHeaders(),
                credentials: 'same-origin'
            });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            currentBookings = await res.json();

            // ä½¿ç”¨ç•¶å‰é¸ä¸­çš„ç¯©é¸å™¨
            const activeFilter = document.querySelector('.filter-btn.active').dataset.status;
            displayBookings(currentBookings, activeFilter);
        } catch (err) {
            console.error(err);
            alert("è¼‰å…¥è¨‚å–®å¤±æ•—ï¼š" + (err.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
    }

    // ç¢ºèªè¨‚å–®
    async function confirmBooking(id) {
        if (!confirm("ç¢ºå®šè¦ç¢ºèªæ­¤è¨‚å–®å—ï¼Ÿ")) return;

        try {
            const res = await fetch(`/api/owner/bookings/${id}/confirm`, {
                method: "POST",
                headers: getHeaders(),
                credentials: 'same-origin'
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || 'ç¢ºèªå¤±æ•—');
            }

            await loadBookings();
            alert('è¨‚å–®å·²ç¢ºèª');
        } catch (err) {
            console.error(err);
            alert(err.message || "ç¢ºèªè¨‚å–®å¤±æ•—");
        }
    }

    // å–æ¶ˆè¨‚å–®
    async function cancelBooking(id) {
        if (!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤è¨‚å–®å—ï¼Ÿ")) return;

        try {
            const res = await fetch(`/api/owner/bookings/${id}/cancel`, {
                method: "POST",
                headers: getHeaders(),
                credentials: 'same-origin'
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || 'å–æ¶ˆå¤±æ•—');
            }

            await loadBookings();
            alert('è¨‚å–®å·²å–æ¶ˆ');
        } catch (err) {
            console.error(err);
            alert(err.message || "å–æ¶ˆè¨‚å–®å¤±æ•—");
        }
    }

    // åŒ¯å‡ºè¨‚å–®åˆ° Excel
    function exportBookings() {
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;

        // å–å¾—ç•¶å‰ç¯©é¸ç‹€æ…‹
        const activeFilter = document.querySelector('.filter-btn.active')?.dataset.status || 'all';
        const status = activeFilter !== 'all' ? activeFilter : '';

        // å»ºç«‹ä¸‹è¼‰ URL
        let url = '/api/export/owner/revenue';
        const params = new URLSearchParams();
        if (status) params.append('status', status);

        // æ—¥æœŸç¯©é¸
        const startDate = document.getElementById('exportStartDate')?.value;
        const endDate = document.getElementById('exportEndDate')?.value;
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);
        if (params.toString()) url += '?' + params.toString();

        btn.innerHTML = 'â³ åŒ¯å‡ºä¸­...';
        btn.disabled = true;

        fetch(url, {
            method: 'GET',
            headers: getHeaders(),
            credentials: 'same-origin'
        })
            .then(response => {
                if (!response.ok) throw new Error('åŒ¯å‡ºå¤±æ•—');
                return response.blob();
            })
            .then(blob => {
                const downloadUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `æˆ¿æ±è¨‚å–®å ±è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(downloadUrl);

                btn.innerHTML = 'âœ… åŒ¯å‡ºæˆåŠŸ';
                setTimeout(() => { btn.innerHTML = originalHTML; btn.disabled = false; }, 1500);
            })
            .catch(err => {
                console.error('åŒ¯å‡ºéŒ¯èª¤:', err);
                alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            });
    }

    // è¨»å†Šç¯©é¸å™¨é»æ“Šäº‹ä»¶
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // æª¢æŸ¥æ˜¯å¦æœ‰æ—¥æœŸç¯©é¸
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            if (startDate || endDate) {
                // å¦‚æœæœ‰æ—¥æœŸç¯©é¸ï¼Œé‡æ–°å¥—ç”¨ç¯©é¸
                applyDateFilter();
            } else {
                // æ²’æœ‰æ—¥æœŸç¯©é¸ï¼Œç›´æ¥é¡¯ç¤ºç‹€æ…‹ç¯©é¸çµæœ
                displayBookings(currentBookings, btn.dataset.status);
            }
        });
    });

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    loadBookings();
</script>
</body>
</html>
