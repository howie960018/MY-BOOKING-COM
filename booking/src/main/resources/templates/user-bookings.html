<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„è¨‚å–® - è¨‚æˆ¿ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-badge.PENDING {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-badge.CONFIRMED {
            background-color: #d4edda;
            color: #155724;
        }
        .status-badge.CANCELLED {
            background-color: #f8d7da;
            color: #721c24;
        }
        .filter-btn {
            margin-right: 5px;
        }
        .filter-btn.active {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>æˆ‘çš„è¨‚å–®</h2>
            <div>
                <button class="btn btn-success me-2" onclick="exportMyBookings()">
                    ğŸ“¥ åŒ¯å‡ºæˆ‘çš„è¨‚å–®
                </button>
                <a href="/" class="btn btn-secondary me-2">è¿”å›é¦–é </a>
                <button class="btn btn-primary" onclick="loadBookings()">é‡æ–°è¼‰å…¥</button>
            </div>
        </div>

        <div class="mb-3">
            <div class="btn-group" role="group" aria-label="è¨‚å–®ç‹€æ…‹ç¯©é¸">
                <button class="btn btn-outline-secondary filter-btn active" data-status="all">å…¨éƒ¨</button>
                <button class="btn btn-outline-warning filter-btn" data-status="PENDING">å¾…ç¢ºèª</button>
                <button class="btn btn-outline-success filter-btn" data-status="CONFIRMED">å·²ç¢ºèª</button>
                <button class="btn btn-outline-danger filter-btn" data-status="CANCELLED">å·²å–æ¶ˆ</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>è¨‚å–®ç·¨è™Ÿ</th>
                        <th>ä½å®¿åç¨±</th>
                        <th>æˆ¿å‹</th>
                        <th>å…¥ä½æ—¥æœŸ</th>
                        <th>é€€æˆ¿æ—¥æœŸ</th>
                        <th>æˆ¿é–“æ•¸</th>
                        <th>ç¸½åƒ¹</th>
                        <th>ç‹€æ…‹</th>
                        <th>å‹•ä½œ</th>
                    </tr>
                </thead>
                <tbody id="bookingList"></tbody>
            </table>
        </div>
    </div>

    <script>
        let currentBookings = [];

        // è™•ç†ç‹€æ…‹æ–‡å­—é¡¯ç¤º
        function getStatusText(status) {
            switch(status) {
                case 'CONFIRMED': return 'å·²ç¢ºèª';
                case 'CANCELLED': return 'å·²å–æ¶ˆ';
                case 'PENDING':
                default: return 'å¾…ç¢ºèª';
            }
        }

        // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
        function displayBookings(bookings, filterStatus = 'all') {
            const tbody = document.getElementById("bookingList");
            const filteredBookings = filterStatus === 'all'
                ? bookings
                : bookings.filter(b => (b.status || 'PENDING') === filterStatus);

            if (filteredBookings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = filteredBookings.map(booking => {
                const status = booking.status || 'PENDING';
                return `
                    <tr data-status="${status}">
                        <td>${booking.id}</td>
                        <td>${booking.roomType?.accommodation?.name || '-'}</td>
                        <td>${booking.roomType?.name || '-'}</td>
                        <td>${booking.checkIn}</td>
                        <td>${booking.checkOut}</td>
                        <td>${booking.bookedQuantity}</td>
                        <td class="text-success fw-bold">
                            NT$ ${Number(booking.totalPrice).toLocaleString()}
                        </td>
                        <td>
                            <span class="status-badge ${status}">
                                ${getStatusText(status)}
                            </span>
                        </td>
                        <td>
                            ${getActionButtons(booking)}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ç²å–æ“ä½œæŒ‰éˆ•
        function getActionButtons(booking) {
            const status = booking.status || 'PENDING';
            if (status === 'CANCELLED' || status === 'CONFIRMED') return '-';

            return `
                <button class="btn btn-danger btn-sm" onclick="cancelBooking(${booking.id})">
                    å–æ¶ˆè¨‚å–®
                </button>
            `;
        }

        // è¼‰å…¥è¨‚å–®åˆ—è¡¨
        async function loadBookings() {
            try {
                const response = await fetch('/api/bookings');
                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');
                currentBookings = await response.json();

                // ä½¿ç”¨ç•¶å‰é¸ä¸­çš„ç¯©é¸å™¨
                const activeFilter = document.querySelector('.filter-btn.active').dataset.status;
                displayBookings(currentBookings, activeFilter);
            } catch (error) {
                console.error(error);
                alert('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼š' + error.message);
            }
        }

        // å–æ¶ˆè¨‚å–®
        async function cancelBooking(id) {
            if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤è¨‚å–®å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/bookings/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('å–æ¶ˆå¤±æ•—');

                await loadBookings();
                alert('è¨‚å–®å·²å–æ¶ˆ');
            } catch (error) {
                console.error(error);
                alert('å–æ¶ˆè¨‚å–®å¤±æ•—ï¼š' + error.message);
            }
        }

        // åŒ¯å‡ºæˆ‘çš„è¨‚å–®
        function exportMyBookings() {
            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'â³ åŒ¯å‡ºä¸­...';
            btn.disabled = true;

            fetch('/api/export/bookings', { method: 'GET', credentials: 'same-origin' })
                .then(response => { if (!response.ok) throw new Error('åŒ¯å‡ºå¤±æ•—'); return response.blob(); })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `æˆ‘çš„è¨‚å–®_${Date.now()}.xlsx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);

                    btn.innerHTML = 'âœ… åŒ¯å‡ºæˆåŠŸ';
                    setTimeout(() => { btn.innerHTML = originalHTML; btn.disabled = false; }, 1500);
                })
                .catch(err => {
                    console.error('åŒ¯å‡ºéŒ¯èª¤:', err);
                    alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                });
        }

        // è¨»å†Šç¯©é¸å™¨é»æ“Šäº‹ä»¶
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                // ç¯©é¸ä¸¦é¡¯ç¤ºè¨‚å–®
                displayBookings(currentBookings, btn.dataset.status);
            });
        });

        // åˆå§‹è¼‰å…¥
        document.addEventListener('DOMContentLoaded', loadBookings);
    </script>
</body>
</html>
