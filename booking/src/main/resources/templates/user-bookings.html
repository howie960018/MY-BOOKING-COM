<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¨‚å–® - è¨‚æˆ¿ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.875rem;
        }
        .status-badge.PENDING {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-badge.CONFIRMED {
            background-color: #d4edda;
            color: #155724;
        }
        .status-badge.CANCELLED {
            background-color: #f8d7da;
            color: #721c24;
        }
        .filter-btn.active {
            background-color: #0d6efd;
            color: white;
        }

        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h2 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }

            /* é ­éƒ¨æŒ‰éˆ•æ”¹ç‚ºå‚ç›´æ’åˆ— */
            .header-actions {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }

            .header-actions .btn {
                width: 100%;
                margin: 0 !important;
            }

            /* ç¯©é¸æŒ‰éˆ•æ”¹ç‚ºä¸‹æ‹‰é¸å–®æ¨£å¼ */
            .btn-group {
                width: 100%;
                flex-direction: column;
            }

            .btn-group .filter-btn {
                width: 100%;
                margin: 2px 0;
                border-radius: 4px !important;
            }

            /* è¡¨æ ¼åœ¨æ‰‹æ©Ÿä¸Šæ”¹ç‚ºå¡ç‰‡å¼ */
            .table-responsive {
                border: none;
            }

            table {
                display: none;
            }

            #mobileBookingList {
                display: block !important;
            }
        }

        /* æ¡Œé¢ç‰ˆéš±è—æ‰‹æ©Ÿå¡ç‰‡ */
        @media (min-width: 769px) {
            #mobileBookingList {
                display: none;
            }
        }

        /* æ‰‹æ©Ÿå¡ç‰‡æ¨£å¼ */
        .booking-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .booking-card-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .booking-card-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .booking-card-label {
            font-weight: 600;
            color: #666;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <!-- é ­éƒ¨ -->
        <div class="mb-4">
            <h2 class="mb-3">æˆ‘çš„è¨‚å–®</h2>
            <div class="header-actions d-flex flex-wrap gap-2">
                <button class="btn btn-success" onclick="exportMyBookings()">
                    ğŸ“¥ åŒ¯å‡ºè¨‚å–®
                </button>
                <a href="/" class="btn btn-secondary">è¿”å›é¦–é </a>
                <button class="btn btn-primary" onclick="loadBookings()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
            </div>
        </div>

        <!-- ç¯©é¸æŒ‰éˆ• -->
        <div class="mb-3">
            <div class="btn-group w-100" role="group" aria-label="è¨‚å–®ç‹€æ…‹ç¯©é¸">
                <button class="btn btn-outline-secondary filter-btn active" data-status="all">å…¨éƒ¨</button>
                <button class="btn btn-outline-warning filter-btn" data-status="PENDING">å¾…ç¢ºèª</button>
                <button class="btn btn-outline-success filter-btn" data-status="CONFIRMED">å·²ç¢ºèª</button>
                <button class="btn btn-outline-danger filter-btn" data-status="CANCELLED">å·²å–æ¶ˆ</button>
            </div>
        </div>

        <!-- æ¡Œé¢ç‰ˆè¡¨æ ¼ -->
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>è¨‚å–®ç·¨è™Ÿ</th>
                        <th>ä½å®¿åç¨±</th>
                        <th>æˆ¿å‹</th>
                        <th>å…¥ä½æ—¥æœŸ</th>
                        <th>é€€æˆ¿æ—¥æœŸ</th>
                        <th>æˆ¿é–“æ•¸</th>
                        <th>ç¸½åƒ¹</th>
                        <th>ç‹€æ…‹</th>
                        <th>å‹•ä½œ</th>
                    </tr>
                </thead>
                <tbody id="bookingList"></tbody>
            </table>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆå¡ç‰‡åˆ—è¡¨ -->
        <div id="mobileBookingList"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentBookings = [];

        // è™•ç†ç‹€æ…‹æ–‡å­—é¡¯ç¤º
        function getStatusText(status) {
            switch(status) {
                case 'CONFIRMED': return 'å·²ç¢ºèª';
                case 'CANCELLED': return 'å·²å–æ¶ˆ';
                case 'PENDING':
                default: return 'å¾…ç¢ºèª';
            }
        }

        // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
        function displayBookings(bookings, filterStatus = 'all') {
            const tbody = document.getElementById("bookingList");
            const mobileList = document.getElementById("mobileBookingList");
            const filteredBookings = filterStatus === 'all'
                ? bookings
                : bookings.filter(b => (b.status || 'PENDING') === filterStatus);

            if (filteredBookings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</td>
                    </tr>`;
                mobileList.innerHTML = `
                    <div class="alert alert-info text-center">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</div>`;
                return;
            }

            // æ¡Œé¢ç‰ˆè¡¨æ ¼
            tbody.innerHTML = filteredBookings.map(booking => {
                const status = booking.status || 'PENDING';
                return `
                    <tr data-status="${status}">
                        <td>${booking.id}</td>
                        <td>${booking.roomType?.accommodation?.name || '-'}</td>
                        <td>${booking.roomType?.name || '-'}</td>
                        <td>${booking.checkIn}</td>
                        <td>${booking.checkOut}</td>
                        <td>${booking.bookedQuantity}</td>
                        <td>NT$${booking.totalPrice?.toLocaleString() || 0}</td>
                        <td><span class="status-badge ${status}">${getStatusText(status)}</span></td>
                        <td>
                            ${status === 'PENDING' || status === 'CONFIRMED'
                                ? `<button class="btn btn-sm btn-danger" onclick="cancelBooking(${booking.id})">å–æ¶ˆè¨‚å–®</button>`
                                : '<span class="text-muted">-</span>'}
                        </td>
                    </tr>`;
            }).join('');

            // æ‰‹æ©Ÿç‰ˆå¡ç‰‡
            mobileList.innerHTML = filteredBookings.map(booking => {
                const status = booking.status || 'PENDING';
                return `
                    <div class="booking-card">
                        <div class="booking-card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>è¨‚å–® #${booking.id}</strong>
                                <span class="status-badge ${status}">${getStatusText(status)}</span>
                            </div>
                        </div>
                        <div class="booking-card-row">
                            <span class="booking-card-label">ä½å®¿ï¼š</span>
                            <span>${booking.roomType?.accommodation?.name || '-'}</span>
                        </div>
                        <div class="booking-card-row">
                            <span class="booking-card-label">æˆ¿å‹ï¼š</span>
                            <span>${booking.roomType?.name || '-'}</span>
                        </div>
                        <div class="booking-card-row">
                            <span class="booking-card-label">å…¥ä½ï¼š</span>
                            <span>${booking.checkIn}</span>
                        </div>
                        <div class="booking-card-row">
                            <span class="booking-card-label">é€€æˆ¿ï¼š</span>
                            <span>${booking.checkOut}</span>
                        </div>
                        <div class="booking-card-row">
                            <span class="booking-card-label">æˆ¿é–“æ•¸ï¼š</span>
                            <span>${booking.bookedQuantity}</span>
                        </div>
                        <div class="booking-card-row">
                            <span class="booking-card-label">ç¸½åƒ¹ï¼š</span>
                            <strong class="text-primary">NT$${booking.totalPrice?.toLocaleString() || 0}</strong>
                        </div>
                        ${status === 'PENDING' || status === 'CONFIRMED'
                            ? `<div class="mt-3">
                                <button class="btn btn-danger w-100" onclick="cancelBooking(${booking.id})">å–æ¶ˆè¨‚å–®</button>
                              </div>`
                            : ''}
                    </div>`;
            }).join('');
        }

        // ç²å–æ“ä½œæŒ‰éˆ•
        function getActionButtons(booking) {
            const status = booking.status || 'PENDING';
            if (status === 'CANCELLED' || status === 'CONFIRMED') return '-';

            return `
                <button class="btn btn-danger btn-sm" onclick="cancelBooking(${booking.id})">
                    å–æ¶ˆè¨‚å–®
                </button>
            `;
        }

        // è¼‰å…¥è¨‚å–®åˆ—è¡¨
        async function loadBookings() {
            try {
                const response = await fetch('/api/bookings');
                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');
                currentBookings = await response.json();

                // ä½¿ç”¨ç•¶å‰é¸ä¸­çš„ç¯©é¸å™¨
                const activeFilter = document.querySelector('.filter-btn.active').dataset.status;
                displayBookings(currentBookings, activeFilter);
            } catch (error) {
                console.error(error);
                alert('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼š' + error.message);
            }
        }

        // å–æ¶ˆè¨‚å–®
        async function cancelBooking(id) {
            if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤è¨‚å–®å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/bookings/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('å–æ¶ˆå¤±æ•—');

                await loadBookings();
                alert('è¨‚å–®å·²å–æ¶ˆ');
            } catch (error) {
                console.error(error);
                alert('å–æ¶ˆè¨‚å–®å¤±æ•—ï¼š' + error.message);
            }
        }

        // åŒ¯å‡ºæˆ‘çš„è¨‚å–®
        function exportMyBookings() {
            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'â³ åŒ¯å‡ºä¸­...';
            btn.disabled = true;

            fetch('/api/export/bookings', { method: 'GET', credentials: 'same-origin' })
                .then(response => { if (!response.ok) throw new Error('åŒ¯å‡ºå¤±æ•—'); return response.blob(); })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `æˆ‘çš„è¨‚å–®_${Date.now()}.xlsx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);

                    btn.innerHTML = 'âœ… åŒ¯å‡ºæˆåŠŸ';
                    setTimeout(() => { btn.innerHTML = originalHTML; btn.disabled = false; }, 1500);
                })
                .catch(err => {
                    console.error('åŒ¯å‡ºéŒ¯èª¤:', err);
                    alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                });
        }

        // è¨»å†Šç¯©é¸å™¨é»æ“Šäº‹ä»¶
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                // ç¯©é¸ä¸¦é¡¯ç¤ºè¨‚å–®
                displayBookings(currentBookings, btn.dataset.status);
            });
        });

        // åˆå§‹è¼‰å…¥
        document.addEventListener('DOMContentLoaded', loadBookings);
    </script>
</body>
</html>
