<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚æˆ¿ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
    <style>
        .accommodation-card { transition: transform .2s; position: relative; }
        .accommodation-card:hover { transform: translateY(-5px); }

        /* ä½å®¿åœ–ç‰‡æ¨£å¼ */
        .accommodation-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0;
        }

        /* æ”¶è—æŒ‰éˆ•æ¨£å¼ */
        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .favorite-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .favorite-btn.favorited {
            background: #ff4757;
            border-color: #ff4757;
            color: white;
        }

        .favorite-btn:not(.favorited) {
            color: #ddd;
        }

        /* Booking.com é¢¨æ ¼æœå°‹å€åŸŸ */
        .search-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 10px;
        }

        .search-hero .card {
            border-radius: 10px;
        }

        .search-hero h2 {
            color: #333;
            font-weight: 700;
        }

        .search-hero .form-label {
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .search-hero .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }

        .search-hero small {
            display: block;
            margin-top: 3px;
        }

        #searchInfo {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#">è¨‚æˆ¿ç³»çµ±</a>
        <div class="navbar-nav ms-auto">
            <a href="/user/favorites" class="btn btn-outline-light btn-sm me-2">â¤ï¸ æˆ‘çš„æ”¶è—</a>
            <a href="/user-bookings" class="btn btn-outline-light btn-sm me-2">ğŸ“‹ æˆ‘çš„è¨‚å–®</a>
            <a href="/user/profile" class="btn btn-outline-light btn-sm me-2">ğŸ‘¤ å€‹äººè³‡æ–™</a>
            <form th:action="@{/logout}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-outline-light btn-sm">ç™»å‡º</button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Booking.com é¢¨æ ¼æœå°‹å€åŸŸ -->
    <div class="search-hero mb-4">
        <div class="card shadow-lg border-0">
            <div class="card-body p-4">
                <h2 class="text-center mb-4">ğŸ¨ å°‹æ‰¾æ‚¨çš„ç†æƒ³ä½å®¿</h2>

                <div class="row g-3 align-items-end">
                    <!-- åœ°é»/é£¯åº—åç¨±æœå°‹ -->
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-geo-alt-fill"></i> åœ°é»æˆ–é£¯åº—åç¨±
                        </label>
                        <input type="text"
                               class="form-control form-control-lg"
                               id="searchQuery"
                               placeholder="ä¾‹ï¼šå°åŒ—ã€æ—¥å®‰æ—…é¤¨"
                               onkeypress="if(event.key==='Enter') performSearch()">
                        <small class="text-muted">è¼¸å…¥åŸå¸‚ã€åœ°å€æˆ–é£¯åº—åç¨±</small>
                    </div>

                    <!-- å…¥ä½æ—¥æœŸ -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold">
                            <i class="bi bi-calendar-check"></i> å…¥ä½æ—¥æœŸ
                        </label>
                        <input type="date"
                               class="form-control form-control-lg"
                               id="checkIn"
                               onchange="handleCheckInChange()">
                    </div>

                    <!-- é€€æˆ¿æ—¥æœŸ -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold">
                            <i class="bi bi-calendar-x"></i> é€€æˆ¿æ—¥æœŸ
                        </label>
                        <input type="date"
                               class="form-control form-control-lg"
                               id="checkOut">
                    </div>

                    <!-- äººæ•¸é¸æ“‡ -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold">
                            <i class="bi bi-people-fill"></i> å…¥ä½äººæ•¸
                        </label>
                        <div class="input-group input-group-lg">
                            <button class="btn btn-outline-secondary" type="button" onclick="changeGuests(-1)">-</button>
                            <input type="number"
                                   class="form-control text-center"
                                   id="guests"
                                   value="2"
                                   min="1"
                                   max="10"
                                   readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="changeGuests(1)">+</button>
                        </div>
                        <small class="text-muted"><span id="guestsText">2 ä½æˆäºº</span></small>
                    </div>

                    <!-- æœå°‹æŒ‰éˆ• -->
                    <div class="col-md-3">
                        <button class="btn btn-primary btn-lg w-100" onclick="performSearch()">
                            ğŸ” æœå°‹ä½å®¿
                        </button>
                        <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="clearSearch()">
                            æ¸…é™¤æ¢ä»¶
                        </button>
                    </div>
                </div>

                <!-- æœå°‹çµæœæç¤º -->
                <div id="searchInfo" class="mt-3 text-center text-muted" style="display:none;">
                    <small></small>
                </div>
            </div>
        </div>
    </div>

    <!-- æ’åºèˆ‡ç¯©é¸ -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 id="resultsTitle">æ‰€æœ‰ä½å®¿</h4>
                    <small class="text-muted" id="resultsCount">è¼‰å…¥ä¸­...</small>
                </div>
                <div>
                    <label class="me-2">æ’åºï¼š</label>
                    <select id="sortBy" class="form-select d-inline-block" style="width: auto;" onchange="applySorting()">
                        <option value="">æˆ‘å€‘çš„æ¨è–¦</option>
                        <option value="price_asc">ğŸ’° åƒ¹æ ¼ï¼šä½åˆ°é«˜</option>
                        <option value="price_desc">ğŸ’° åƒ¹æ ¼ï¼šé«˜åˆ°ä½</option>
                        <option value="rating">â­ è©•åˆ†æœ€é«˜</option>
                        <option value="popularity">ğŸ”¥ æœ€å—æ­¡è¿</option>
                        <option value="distance">ğŸ“ è·é›¢æœ€è¿‘</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- ä½å®¿åˆ—è¡¨ -->
    <div class="row">
        <div class="col-12">
            <div id="accommodations" class="row"></div>
            <div id="noResults" style="display:none;" class="text-center py-5">
                <h3>ğŸ˜” æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ä½å®¿</h3>
                <p class="text-muted">è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶</p>
                <button class="btn btn-primary" onclick="clearSearch()">æ¸…é™¤æ‰€æœ‰æ¢ä»¶</button>
            </div>
        </div>
    </div>
</div>

<!-- è¨‚æˆ¿ Modalï¼ˆå®Œæ•´ç‰ˆ - èˆ‡è©³æƒ…é ç›¸åŒï¼‰ -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ¯ ç¢ºèªè¨‚æˆ¿</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6 id="modalAccommodationName" class="text-primary"></h6>
                    <p class="text-muted" id="modalLocation"></p>
                </div>

                <!-- é¸æ“‡æˆ¿å‹ -->
                <div class="mb-3">
                    <label class="form-label">é¸æ“‡æˆ¿å‹ <span class="text-danger">*</span></label>
                    <select class="form-select" id="modalRoomTypeSelect" onchange="updateBookingPrice()">
                        <option value="">è«‹é¸æ“‡æˆ¿å‹</option>
                    </select>
                    <div class="form-text" id="roomTypeStock"></div>
                </div>

                <!-- æ—¥æœŸé¸æ“‡ -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">å…¥ä½æ—¥æœŸ <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="modalCheckIn"
                               onchange="validateDates(); updateBookingPrice();">
                        <div class="invalid-feedback" id="checkInError"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">é€€æˆ¿æ—¥æœŸ <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="modalCheckOut"
                               onchange="validateDates(); updateBookingPrice();">
                        <div class="invalid-feedback" id="checkOutError"></div>
                    </div>
                </div>

                <!-- æˆ¿é–“æ•¸é‡ -->
                <div class="mb-3">
                    <label class="form-label">æˆ¿é–“æ•¸é‡ <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="modalQuantity"
                           min="1" max="1" value="1"
                           onchange="validateQuantity(); updateBookingPrice();">
                    <div class="form-text">
                        <span id="quantityHint">è«‹å…ˆé¸æ“‡æˆ¿å‹</span>
                    </div>
                    <div class="invalid-feedback" id="quantityError"></div>
                </div>

                <!-- ç¸½åƒ¹é¡¯ç¤º -->
                <div class="alert alert-info">
                    <h5>è¨‚å–®ç¸½è¨ˆ</h5>
                    <div class="d-flex justify-content-between">
                        <span>æˆ¿å‹åƒ¹æ ¼ï¼š</span>
                        <span id="displayRoomPrice">NT$ 0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>ä½å®¿å¤©æ•¸ï¼š</span>
                        <span id="displayNights">0 æ™š</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>æˆ¿é–“æ•¸é‡ï¼š</span>
                        <span id="displayQuantity">1 é–“</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>ç¸½åƒ¹ï¼š</strong>
                        <strong class="text-primary" id="displayTotalPrice">NT$ 0</strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmBooking()">ç¢ºèªè¨‚æˆ¿</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let bookingModal;
    let currentAccId = null;
    let roomTypesCache = {}; // accId -> roomTypes
    let roomTypesData = [];  // ç•¶å‰é¸æ“‡çš„ä½å®¿çš„æˆ¿å‹è³‡æ–™

    // ç²å– CSRF token
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    // å‰µå»ºå¸¶ CSRF token çš„ fetch é¸é …
    function getFetchOptions(method = 'GET', body = null) {
        const options = {
            method: method,
            headers: {}
        };

        if (csrfToken && csrfHeader) {
            options.headers[csrfHeader] = csrfToken;
        }

        if (body) {
            if (body instanceof FormData) {
                options.body = body;
            } else {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
        }

        return options;
    }

    document.addEventListener('DOMContentLoaded', () => {
        bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        loadAllAccommodations();
        setMinDate(); // è¨­å®šæœ€å°æ—¥æœŸç‚ºä»Šå¤©
        initSearchDates(); // åˆå§‹åŒ–æœå°‹æ—¥æœŸ
    });

    // åˆå§‹åŒ–æœå°‹æ—¥æœŸï¼ˆé è¨­æ˜å¤©å’Œå¾Œå¤©ï¼‰
    function initSearchDates() {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const dayAfter = new Date(today);
        dayAfter.setDate(dayAfter.getDate() + 2);

        const checkInInput = document.getElementById('checkIn');
        const checkOutInput = document.getElementById('checkOut');

        checkInInput.min = today.toISOString().split('T')[0];
        checkOutInput.min = tomorrow.toISOString().split('T')[0];

        checkInInput.value = tomorrow.toISOString().split('T')[0];
        checkOutInput.value = dayAfter.toISOString().split('T')[0];
    }

    // è™•ç†å…¥ä½æ—¥æœŸè®Šæ›´
    function handleCheckInChange() {
        const checkIn = document.getElementById('checkIn').value;
        const checkOut = document.getElementById('checkOut').value;

        if (checkIn) {
            const checkInDate = new Date(checkIn);
            const minCheckOut = new Date(checkInDate);
            minCheckOut.setDate(minCheckOut.getDate() + 1);

            document.getElementById('checkOut').min = minCheckOut.toISOString().split('T')[0];

            // å¦‚æœé€€æˆ¿æ—¥æœŸæ—©æ–¼æˆ–ç­‰æ–¼å…¥ä½æ—¥æœŸï¼Œè‡ªå‹•èª¿æ•´
            if (!checkOut || new Date(checkOut) <= checkInDate) {
                document.getElementById('checkOut').value = minCheckOut.toISOString().split('T')[0];
            }
        }
    }

    // è®Šæ›´äººæ•¸
    function changeGuests(delta) {
        const input = document.getElementById('guests');
        const current = parseInt(input.value);
        const newValue = Math.max(1, Math.min(10, current + delta));
        input.value = newValue;
        document.getElementById('guestsText').textContent = `${newValue} ä½æˆäºº`;
    }

    // çµ±ä¸€æœå°‹åŠŸèƒ½ï¼ˆåœ°é»/åç¨± + æ—¥æœŸ + äººæ•¸ï¼‰
    function performSearch() {
        const query = document.getElementById('searchQuery').value.trim();
        const checkIn = document.getElementById('checkIn').value;
        const checkOut = document.getElementById('checkOut').value;
        const guests = document.getElementById('guests').value;
        const sortBy = document.getElementById('sortBy').value;

        console.log('ğŸ” performSearch åƒæ•¸:', { query, checkIn, checkOut, guests, sortBy });

        // å»ºç«‹æœå°‹æ¢ä»¶
        let searchParams = new URLSearchParams();

        if (query) {
            searchParams.append('query', query);
        }

        if (checkIn && checkOut) {
            if (checkIn >= checkOut) {
                showAlert('å…¥ä½æ—¥æœŸå¿…é ˆæ—©æ–¼é€€æˆ¿æ—¥æœŸ', 'warning');
                return;
            }
            searchParams.append('checkIn', checkIn);
            searchParams.append('checkOut', checkOut);
        }

        if (guests) {
            searchParams.append('guests', guests);
        }

        if (sortBy) {
            searchParams.append('sortBy', sortBy);
        }

        // æ±ºå®šä½¿ç”¨å“ªå€‹ API
        let url = '/api/accommodations';

        if (query && (checkIn && checkOut)) {
            // åŒæ™‚æœ‰é—œéµå­—å’Œæ—¥æœŸï¼šä½¿ç”¨è¤‡åˆæœå°‹
            url = `/api/accommodations/search?${searchParams.toString()}`;
        } else if (query) {
            // åªæœ‰é—œéµå­—ï¼šæœå°‹åœ°é»æˆ–åç¨±
            url = `/api/accommodations/search?query=${encodeURIComponent(query)}`;
            if (sortBy) url += `&sortBy=${sortBy}`;
        } else if (checkIn && checkOut) {
            // åªæœ‰æ—¥æœŸï¼šæŸ¥è©¢å¯ç”¨ä½å®¿
            url = `/api/accommodations/available?checkIn=${checkIn}&checkOut=${checkOut}`;
            if (sortBy) url += `&sortBy=${sortBy}`;
        } else if (sortBy) {
            // åªæœ‰æ’åº
            url = `/api/accommodations?sortBy=${sortBy}`;
        }

        console.log('ğŸ“¡ API URL:', url);

        // é¡¯ç¤ºæœå°‹è³‡è¨Š
        updateSearchInfo(query, checkIn, checkOut, guests);

        // åŸ·è¡Œæœå°‹
        fetch(url)
            .then(r => r.json())
            .then(data => {
                console.log('âœ… API è¿”å›è³‡æ–™æ•¸é‡:', data.length);
                if (data.length > 0) {
                    console.log('ğŸ“Š å‰ 3 ç­†è³‡æ–™:', data.slice(0, 3).map(a => ({
                        id: a.id,
                        name: a.name,
                        price: a.pricePerNight
                    })));
                }
                displayAccommodations(data);
                updateResultsTitle(query, checkIn, checkOut);
            })
            .catch((error) => {
                console.error('âŒ API éŒ¯èª¤:', error);
                showAlert('æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'danger');
            });
    }

    // æ›´æ–°æœå°‹è³‡è¨Šé¡¯ç¤º
    function updateSearchInfo(query, checkIn, checkOut, guests) {
        const searchInfo = document.getElementById('searchInfo');
        const parts = [];

        if (query) parts.push(`é—œéµå­—: "${query}"`);
        if (checkIn && checkOut) {
            const nights = calculateDays(checkIn, checkOut);
            parts.push(`${checkIn} - ${checkOut} (${nights}æ™š)`);
        }
        if (guests) parts.push(`${guests}ä½æˆäºº`);

        if (parts.length > 0) {
            searchInfo.querySelector('small').textContent = `æœå°‹æ¢ä»¶: ${parts.join(' | ')}`;
            searchInfo.style.display = 'block';
        } else {
            searchInfo.style.display = 'none';
        }
    }

    // æ›´æ–°çµæœæ¨™é¡Œ
    function updateResultsTitle(query, checkIn, checkOut) {
        const title = document.getElementById('resultsTitle');

        if (query && (checkIn && checkOut)) {
            title.textContent = `"${query}" çš„å¯ç”¨ä½å®¿`;
        } else if (query) {
            title.textContent = `"${query}" çš„æœå°‹çµæœ`;
        } else if (checkIn && checkOut) {
            title.textContent = `å¯ç”¨ä½å®¿`;
        } else {
            title.textContent = `æ‰€æœ‰ä½å®¿`;
        }
    }

    // æ¸…é™¤æœå°‹æ¢ä»¶
    function clearSearch() {
        document.getElementById('searchQuery').value = '';
        document.getElementById('guests').value = '2';
        document.getElementById('guestsText').textContent = '2 ä½æˆäºº';
        document.getElementById('sortBy').value = '';

        initSearchDates(); // é‡ç½®æ—¥æœŸç‚ºé è¨­å€¼

        loadAllAccommodations();

        document.getElementById('searchInfo').style.display = 'none';
        document.getElementById('resultsTitle').textContent = 'æ‰€æœ‰ä½å®¿';
    }

    // æ‡‰ç”¨æ’åºï¼ˆä¿ç•™æœå°‹æ¢ä»¶ï¼‰
    function applySorting() {
        const sortBy = document.getElementById('sortBy').value;
        console.log('ğŸ”§ applySorting è¢«èª¿ç”¨ï¼ŒsortBy =', sortBy);
        performSearch();
    }

    // è¨­å®šæ—¥æœŸæœ€å°å€¼ç‚ºä»Šå¤©
    function setMinDate() {
        const today = new Date().toISOString().split('T')[0];
        const checkInInput = document.getElementById('modalCheckIn');
        const checkOutInput = document.getElementById('modalCheckOut');

        checkInInput.min = today;
        checkOutInput.min = today;

        // è¨­å®šé è¨­å€¼ç‚ºæ˜å¤©å’Œå¾Œå¤©
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const dayAfter = new Date();
        dayAfter.setDate(dayAfter.getDate() + 2);

        checkInInput.value = tomorrow.toISOString().split('T')[0];
        checkOutInput.value = dayAfter.toISOString().split('T')[0];
    }

    // é©—è­‰æ—¥æœŸ
    function validateDates() {
        const checkIn = document.getElementById('modalCheckIn').value;
        const checkOut = document.getElementById('modalCheckOut').value;
        const checkInInput = document.getElementById('modalCheckIn');
        const checkOutInput = document.getElementById('modalCheckOut');
        const checkInError = document.getElementById('checkInError');
        const checkOutError = document.getElementById('checkOutError');

        let isValid = true;

        // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤
        checkInInput.classList.remove('is-invalid');
        checkOutInput.classList.remove('is-invalid');
        checkInError.textContent = '';
        checkOutError.textContent = '';

        if (!checkIn) {
            checkInInput.classList.add('is-invalid');
            checkInError.textContent = 'è«‹é¸æ“‡å…¥ä½æ—¥æœŸ';
            isValid = false;
        }

        if (!checkOut) {
            checkOutInput.classList.add('is-invalid');
            checkOutError.textContent = 'è«‹é¸æ“‡é€€æˆ¿æ—¥æœŸ';
            isValid = false;
        }

        if (checkIn && checkOut) {
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // æª¢æŸ¥å…¥ä½æ—¥æœŸä¸èƒ½æ—©æ–¼ä»Šå¤©
            if (checkInDate < today) {
                checkInInput.classList.add('is-invalid');
                checkInError.textContent = 'å…¥ä½æ—¥æœŸä¸èƒ½æ—©æ–¼ä»Šå¤©';
                isValid = false;
            }

            // æª¢æŸ¥é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ
            if (checkOutDate <= checkInDate) {
                checkOutInput.classList.add('is-invalid');
                checkOutError.textContent = 'é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ';
                isValid = false;
            }

            // è‡ªå‹•èª¿æ•´é€€æˆ¿æ—¥æœŸ
            if (checkOutDate <= checkInDate) {
                const nextDay = new Date(checkInDate);
                nextDay.setDate(nextDay.getDate() + 1);
                checkOutInput.value = nextDay.toISOString().split('T')[0];
            }

            // æ›´æ–°é€€æˆ¿æ—¥æœŸçš„æœ€å°å€¼
            if (checkIn) {
                const minCheckOut = new Date(checkInDate);
                minCheckOut.setDate(minCheckOut.getDate() + 1);
                checkOutInput.min = minCheckOut.toISOString().split('T')[0];
            }
        }

        return isValid;
    }

    // é©—è­‰æˆ¿é–“æ•¸é‡
    function validateQuantity() {
        const select = document.getElementById('modalRoomTypeSelect');
        const quantityInput = document.getElementById('modalQuantity');
        const quantityError = document.getElementById('quantityError');
        const selectedOption = select.options[select.selectedIndex];

        quantityInput.classList.remove('is-invalid');
        quantityError.textContent = '';

        if (!selectedOption.value) {
            return true; // é‚„æ²’é¸æ“‡æˆ¿å‹ï¼Œä¸é©—è­‰
        }

        const maxRooms = parseInt(selectedOption.dataset.totalRooms || 1);
        const quantity = parseInt(quantityInput.value || 1);

        if (quantity < 1) {
            quantityInput.value = 1;
            quantityInput.classList.add('is-invalid');
            quantityError.textContent = 'æˆ¿é–“æ•¸é‡è‡³å°‘ç‚º 1';
            return false;
        }

        if (quantity > maxRooms) {
            quantityInput.value = maxRooms;
            quantityInput.classList.add('is-invalid');
            quantityError.textContent = `æ­¤æˆ¿å‹æœ€å¤šåªæœ‰ ${maxRooms} é–“å¯é è¨‚`;

            // 3ç§’å¾Œè‡ªå‹•æ¸…é™¤éŒ¯èª¤æç¤º
            setTimeout(() => {
                quantityInput.classList.remove('is-invalid');
                quantityError.textContent = '';
            }, 3000);

            return false;
        }

        return true;
    }

    function loadAllAccommodations() {
        const sortBy = document.getElementById('sortBy')?.value || '';
        const url = sortBy ? `/api/accommodations?sortBy=${sortBy}` : '/api/accommodations';
        fetch(url)
            .then(r => r.json())
            .then(displayAccommodations)
            .catch(() => showAlert('è¼‰å…¥ä½å®¿å¤±æ•—', 'danger'));
    }

    function searchByLocation() {
        const location = document.getElementById('locationSearch').value.trim();
        if (!location) return showAlert('è«‹è¼¸å…¥æœå°‹åœ°é»', 'warning');

        const sortBy = document.getElementById('sortBy')?.value || '';
        let url = '/api/accommodations/search?location=' + encodeURIComponent(location);
        if (sortBy) url += '&sortBy=' + sortBy;

        fetch(url)
            .then(r => r.json())
            .then(displayAccommodations)
            .catch(() => showAlert('æœå°‹å¤±æ•—', 'danger'));
    }

    function searchAvailable() {
        const checkIn = document.getElementById('checkIn').value;
        const checkOut = document.getElementById('checkOut').value;
        if (!checkIn || !checkOut) return showAlert('è«‹é¸æ“‡å…¥ä½å’Œé€€æˆ¿æ—¥æœŸ', 'warning');
        if (checkIn >= checkOut) return showAlert('å…¥ä½æ—¥æœŸå¿…é ˆæ—©æ–¼é€€æˆ¿æ—¥æœŸ', 'warning');

        fetch(`/api/accommodations/available?checkIn=${checkIn}&checkOut=${checkOut}`)
            .then(r => r.json())
            .then(displayAccommodations)
            .catch(() => showAlert('æŸ¥è©¢å¤±æ•—', 'danger'));
    }

    function displayAccommodations(list) {
        const c = document.getElementById('accommodations');
        const noResults = document.getElementById('noResults');
        const resultsCount = document.getElementById('resultsCount');

        if (!list || list.length === 0) {
            c.innerHTML = '';
            noResults.style.display = 'block';
            resultsCount.textContent = 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ä½å®¿';
            return;
        }

        noResults.style.display = 'none';
        resultsCount.textContent = `æ‰¾åˆ° ${list.length} é–“ä½å®¿`;

        c.innerHTML = list.map(acc => `
      <div class="col-md-4 mb-3">
        <div class="card accommodation-card h-100">
          <button class="favorite-btn" id="fav-${acc.id}" onclick="toggleFavorite(${acc.id}, event)" title="æ”¶è—">
            ğŸ¤
          </button>
          <!-- ä½å®¿åœ–ç‰‡ -->
          <img src="${acc.imageUrl || 'https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400'}"
               class="card-img-top accommodation-image"
               alt="${escapeHtml(acc.name)}"
               onerror="this.src='https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400'">

          <div class="card-body">
            <h5 class="card-title">${acc.name}</h5>
            ${acc.rating ? `<div class="mb-2"><span class="badge bg-warning text-dark">â­ ${acc.rating}</span> <small class="text-muted">(${acc.reviewCount || 0} å‰‡è©•è«–)</small></div>` : ''}
            <p class="card-text">
              <strong>ğŸ“ åœ°é»:</strong> ${acc.location}<br>
              <strong>ğŸ“ æè¿°:</strong> ${acc.description || ''}<br>
              <strong>ğŸ’° åƒ¹æ ¼:</strong> NT$ ${acc.pricePerNight || 0} / æ™š<br>
              ${acc.distanceFromCenter ? `<strong>ğŸš¶ è·é›¢å¸‚ä¸­å¿ƒ:</strong> ${acc.distanceFromCenter} å…¬é‡Œ<br>` : ''}
              ${acc.bookingCount > 100 ? `<span class="badge bg-danger">ğŸ”¥ ç†±é–€</span>` : ''}
            </p>
            <div class="d-flex gap-2">
              <a href="/accommodations/${acc.id}" class="btn btn-info flex-fill">
                ğŸ“– æŸ¥çœ‹è©³æƒ…
              </a>
              <button class="btn btn-primary flex-fill" onclick="openBookingModal(${acc.id}, '${escapeHtml(acc.name)}', '${escapeHtml(acc.location)}')">
                ğŸ” å¿«é€Ÿè¨‚æˆ¿
              </button>
            </div>
          </div>
        </div>
      </div>
    `).join('');

        // è¼‰å…¥æ”¶è—ç‹€æ…‹
        loadFavoriteStates(list.map(acc => acc.id));
    }

    function openBookingModal(accId, name, location) {
        currentAccId = accId;

        // è¨­å®šä½å®¿è³‡è¨Š
        document.getElementById('modalAccommodationName').textContent = name;
        document.getElementById('modalLocation').textContent = 'ğŸ“ ' + location;

        // è¼‰å…¥æˆ¿å‹
        loadRoomTypes(accId).then(() => {
            // æ¸…é™¤æ‰€æœ‰éŒ¯èª¤æç¤º
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

            bookingModal.show();
            updateBookingPrice();
        });
    }

    function loadRoomTypes(accId) {
        if (roomTypesCache[accId]) {
            fillRoomTypeSelect(roomTypesCache[accId]);
            roomTypesData = roomTypesCache[accId];
            return Promise.resolve();
        }
        return fetch(`/api/room-types/by-accommodation/${accId}`)
            .then(r => r.json())
            .then(list => {
                roomTypesCache[accId] = list;
                roomTypesData = list;
                fillRoomTypeSelect(list);
            })
            .catch(() => showAlert('è¼‰å…¥æˆ¿å‹å¤±æ•—', 'danger'));
    }

    function fillRoomTypeSelect(list) {
        const sel = document.getElementById('modalRoomTypeSelect');
        if (!list || list.length === 0) {
            sel.innerHTML = '<option value="">æ­¤ä½å®¿å°šç„¡æˆ¿å‹</option>';
            return;
        }
        sel.innerHTML = '<option value="">è«‹é¸æ“‡æˆ¿å‹</option>' +
            list.map(rt => `
                <option value="${rt.id}"
                        data-price="${rt.pricePerNight || 0}"
                        data-total-rooms="${rt.totalRooms || 1}">
                    ${rt.name} - NT$ ${rt.pricePerNight || 0} / æ™š (å‰©é¤˜ ${rt.totalRooms || 0} é–“)
                </option>
            `).join('');
    }

    // æ›´æ–°è¨‚æˆ¿åƒ¹æ ¼ï¼ˆèˆ‡è©³æƒ…é ç›¸åŒçš„é‚è¼¯ï¼‰
    function updateBookingPrice() {
        const select = document.getElementById('modalRoomTypeSelect');
        const selectedOption = select.options[select.selectedIndex];
        const roomPrice = parseFloat(selectedOption.dataset.price || 0);
        const totalRooms = parseInt(selectedOption.dataset.totalRooms || 1);

        const quantityInput = document.getElementById('modalQuantity');
        const roomTypeStock = document.getElementById('roomTypeStock');
        const quantityHint = document.getElementById('quantityHint');

        // æ›´æ–°æˆ¿å‹åº«å­˜æç¤º
        if (selectedOption.value) {
            roomTypeStock.textContent = `æ­¤æˆ¿å‹å…±æœ‰ ${totalRooms} é–“å¯é è¨‚`;
            roomTypeStock.className = 'form-text text-success';

            // æ›´æ–°æˆ¿é–“æ•¸é‡ä¸Šé™
            quantityInput.max = totalRooms;
            quantityHint.textContent = `æœ€å¤šå¯é è¨‚ ${totalRooms} é–“`;

            // å¦‚æœç•¶å‰æ•¸é‡è¶…éåº«å­˜ï¼Œè‡ªå‹•èª¿æ•´
            if (parseInt(quantityInput.value) > totalRooms) {
                quantityInput.value = totalRooms;
            }
        } else {
            roomTypeStock.textContent = '';
            quantityInput.max = 1;
            quantityHint.textContent = 'è«‹å…ˆé¸æ“‡æˆ¿å‹';
        }

        const checkIn = document.getElementById('modalCheckIn').value;
        const checkOut = document.getElementById('modalCheckOut').value;
        const quantity = parseInt(quantityInput.value) || 1;

        // è¨ˆç®—ä½å®¿å¤©æ•¸
        let nights = 0;
        if (checkIn && checkOut) {
            const start = new Date(checkIn);
            const end = new Date(checkOut);
            nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            if (nights < 0) nights = 0;
        }

        // æ›´æ–°é¡¯ç¤º
        document.getElementById('displayRoomPrice').textContent = `NT$ ${roomPrice.toLocaleString()}`;
        document.getElementById('displayNights').textContent = `${nights} æ™š`;
        document.getElementById('displayQuantity').textContent = `${quantity} é–“`;

        const totalPrice = roomPrice * nights * quantity;
        document.getElementById('displayTotalPrice').textContent = `NT$ ${totalPrice.toLocaleString()}`;
    }

    function confirmBooking() {
        const roomTypeId = document.getElementById('modalRoomTypeSelect').value;
        const checkIn = document.getElementById('modalCheckIn').value;
        const checkOut = document.getElementById('modalCheckOut').value;
        const quantity = parseInt(document.getElementById('modalQuantity').value) || 1;
        const select = document.getElementById('modalRoomTypeSelect');
        const selectedOption = select.options[select.selectedIndex];
        const maxRooms = parseInt(selectedOption.dataset.totalRooms || 1);

        // é©—è­‰æˆ¿å‹
        if (!roomTypeId) {
            alert('âŒ è«‹é¸æ“‡æˆ¿å‹');
            return;
        }

        // é©—è­‰æ—¥æœŸ
        if (!checkIn || !checkOut) {
            alert('âŒ è«‹é¸æ“‡å…¥ä½å’Œé€€æˆ¿æ—¥æœŸ');
            return;
        }

        // é©—è­‰æ—¥æœŸé‚è¼¯
        if (!validateDates()) {
            alert('âŒ è«‹æª¢æŸ¥æ—¥æœŸæ˜¯å¦æ­£ç¢º');
            return;
        }

        const start = new Date(checkIn);
        const end = new Date(checkOut);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (start < today) {
            alert('âŒ å…¥ä½æ—¥æœŸä¸èƒ½æ—©æ–¼ä»Šå¤©');
            return;
        }

        if (end <= start) {
            alert('âŒ é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ');
            return;
        }

        // é©—è­‰æˆ¿é–“æ•¸é‡
        if (quantity < 1) {
            alert('âŒ æˆ¿é–“æ•¸é‡è‡³å°‘ç‚º 1');
            return;
        }

        if (quantity > maxRooms) {
            alert(`âŒ æ­¤æˆ¿å‹æœ€å¤šåªæœ‰ ${maxRooms} é–“å¯é è¨‚\næ‚¨é¸æ“‡äº† ${quantity} é–“ï¼Œè«‹èª¿æ•´æ•¸é‡`);
            return;
        }

        // ç™¼é€è¨‚æˆ¿è«‹æ±‚
        const formData = new FormData();
        formData.append('roomTypeId', roomTypeId);
        formData.append('checkIn', checkIn);
        formData.append('checkOut', checkOut);
        formData.append('quantity', quantity);

        fetch('/api/bookings/book-by-room-type', getFetchOptions('POST', formData))
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('âœ… è¨‚æˆ¿æˆåŠŸï¼\nè¨‚å–®ç·¨è™Ÿï¼š' + data.bookingId);
                bookingModal.hide();
                if (confirm('æ˜¯å¦å‰å¾€æŸ¥çœ‹è¨‚å–®ï¼Ÿ')) {
                    window.location.href = '/user-bookings';
                }
            } else {
                alert('âŒ è¨‚æˆ¿å¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
            }
        })
        .catch(err => {
            console.error('è¨‚æˆ¿å¤±æ•—:', err);
            alert('âŒ è¨‚æˆ¿å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        });
    }

    // å‰µå»ºé€šç”¨çš„ fetch headersï¼ˆä¿ç•™èˆŠä»£ç¢¼å…¼å®¹æ€§ï¼‰
    const getHeaders = () => {
        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        return headers;
    };

    function calculateDays(checkIn, checkOut) {
        const s = new Date(checkIn);
        const e = new Date(checkOut);
        const ms = e - s;
        if (isNaN(ms) || ms <= 0) return 0;
        return Math.ceil(ms / (1000*60*60*24));
    }

    function showAlert(message, type) {
        const div = document.createElement('div');
        div.className = `alert alert-${type} alert-dismissible fade show`;
        div.innerHTML = `${escapeHtml(message)}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        const container = document.querySelector('.container');
        container.insertBefore(div, container.firstElementChild);
        setTimeout(() => div.remove(), 5000);
    }

    function escapeHtml(s) {
        return String(s || '')
            .replace(/&/g,'&amp;').replace(/</g,'&lt;')
            .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // ========== æ”¶è—åŠŸèƒ½ ==========

    /**
     * è¼‰å…¥æ‰€æœ‰ä½å®¿çš„æ”¶è—ç‹€æ…‹
     */
    function loadFavoriteStates(accommodationIds) {
        accommodationIds.forEach(id => {
            fetch(`/user/favorites/api/check/${id}`, {
                headers: getHeaders(),
                credentials: 'same-origin'
            })
            .then(r => r.json())
            .then(data => {
                updateFavoriteButton(id, data.isFavorited);
            })
            .catch(e => console.error('è¼‰å…¥æ”¶è—ç‹€æ…‹å¤±æ•—:', e));
        });
    }

    /**
     * åˆ‡æ›æ”¶è—ç‹€æ…‹
     */
    function toggleFavorite(accommodationId, event) {
        event.stopPropagation(); // é˜²æ­¢è§¸ç™¼å¡ç‰‡é»æ“Šäº‹ä»¶

        fetch(`/user/favorites/api/toggle/${accommodationId}`, {
            method: 'POST',
            headers: getHeaders(),
            credentials: 'same-origin'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                updateFavoriteButton(accommodationId, data.isFavorited);
                showAlert(data.message, 'success');
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(e => {
            console.error('æ”¶è—æ“ä½œå¤±æ•—:', e);
            showAlert('æ”¶è—æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'danger');
        });
    }

    /**
     * æ›´æ–°æ”¶è—æŒ‰éˆ•çš„é¡¯ç¤ºç‹€æ…‹
     */
    function updateFavoriteButton(accommodationId, isFavorited) {
        const btn = document.getElementById(`fav-${accommodationId}`);
        if (!btn) return;

        if (isFavorited) {
            btn.classList.add('favorited');
            btn.textContent = 'â¤ï¸';
            btn.title = 'å·²æ”¶è— - é»æ“Šå–æ¶ˆ';
        } else {
            btn.classList.remove('favorited');
            btn.textContent = 'ğŸ¤';
            btn.title = 'é»æ“Šæ”¶è—';
        }
    }


    /**
     * è‡ªå‹•æ‰“é–‹è¨‚æˆ¿ Modalï¼ˆå¾æ”¶è—é é¢è·³è½‰éä¾†æ™‚ä½¿ç”¨ï¼‰
     */
    function autoOpenBookingModal(accommodationId) {
        // å˜—è©¦å¾é é¢ä¸Šæ‰¾åˆ°å°æ‡‰çš„ä½å®¿è³‡è¨Š
        fetch('/api/accommodations')
            .then(r => r.json())
            .then(list => {
                const accommodation = list.find(acc => acc.id === accommodationId);
                if (accommodation) {
                    openBookingModal(accommodation.id, accommodation.name, accommodation.location);
                } else {
                    showAlert('æ‰¾ä¸åˆ°æŒ‡å®šçš„ä½å®¿', 'warning');
                }
            })
            .catch(e => {
                console.error('è¼‰å…¥ä½å®¿è³‡è¨Šå¤±æ•—:', e);
                showAlert('è¼‰å…¥ä½å®¿è³‡è¨Šå¤±æ•—', 'danger');
            });
    }

</script>
</body>
</html>
