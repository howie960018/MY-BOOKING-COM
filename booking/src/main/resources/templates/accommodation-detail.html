<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>ä½å®¿è©³æƒ…</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .main-image {
            grid-column: 1 / 3;
            grid-row: 1 / 3;
        }

        .gallery-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .gallery-image:hover {
            transform: scale(1.05);
        }

        .main-image .gallery-image {
            height: 400px;
        }

        .side-image .gallery-image {
            height: 195px;
        }

        .rating-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            display: inline-block;
        }

        .rating-text {
            font-size: 18px;
            color: #666;
            margin-left: 10px;
        }

        .amenity-item {
            display: inline-block;
            background: #e7f3ff;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            border: 1px solid #90caf9;
        }

        .room-type-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            transition: box-shadow 0.3s;
        }

        .room-type-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .review-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .review-rating {
            color: #ffc107;
            font-size: 18px;
        }

        .review-author {
            color: #666;
            font-size: 14px;
        }

        .review-date {
            color: #999;
            font-size: 13px;
        }

        .review-helpful {
            color: #28a745;
            font-size: 13px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .add-review-form {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .star-rating {
            font-size: 30px;
            cursor: pointer;
            color: #ddd;
        }

        .star-rating .star {
            transition: color 0.2s;
        }

        .star-rating .star.active,
        .star-rating .star:hover {
            color: #ffc107;
        }

        .nearby-item {
            padding: 10px 15px;
            background: #f8f9fa;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .contact-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .breadcrumb {
            background: none;
            padding: 0;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<!-- å°èˆªæ¬„ -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">ğŸ¨ è¨‚æˆ¿ç³»çµ±</a>
        <div class="navbar-nav ms-auto">
            <a href="/user/favorites" class="btn btn-outline-light btn-sm me-2">â¤ï¸ æˆ‘çš„æ”¶è—</a>
            <a href="/user-bookings" class="btn btn-outline-light btn-sm me-2">ğŸ“‹ æˆ‘çš„è¨‚å–®</a>
            <a href="/user/profile" class="btn btn-outline-light btn-sm me-2">ğŸ‘¤ å€‹äººè³‡æ–™</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- éºµåŒ…å±‘ -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">é¦–é </a></li>
            <li class="breadcrumb-item active" aria-current="page" id="breadcrumb-name">ä½å®¿è©³æƒ…</li>
        </ol>
    </nav>

    <!-- åœ–ç‰‡ç•«å»Š -->
    <div class="image-gallery" id="imageGallery">
        <!-- å‹•æ…‹è¼‰å…¥ -->
    </div>

    <div class="row">
        <!-- å·¦å´ï¼šä½å®¿è³‡è¨Š -->
        <div class="col-lg-8">
            <!-- åŸºæœ¬è³‡è¨Š -->
            <div class="mb-4">
                <h1 id="accommodationName"></h1>
                <p class="text-muted">
                    <span id="accommodationLocation"></span> â€¢
                    <span id="accommodationDistance"></span>
                </p>
                <div class="mb-3">
                    <span class="rating-badge" id="ratingBadge"></span>
                    <span class="rating-text" id="ratingText"></span>
                </div>
            </div>

            <!-- è¨­æ–½ -->
            <div class="section-title">ğŸ  è¨­æ–½èˆ‡æœå‹™</div>
            <div id="amenitiesList"></div>

            <!-- ä½å®¿æè¿° -->
            <div class="section-title">ğŸ“ ä½å®¿ä»‹ç´¹</div>
            <p id="accommodationDescription"></p>

            <!-- æˆ¿å‹åˆ—è¡¨ -->
            <div class="section-title">ğŸ›ï¸ æˆ¿å‹é¸æ“‡</div>
            <div id="roomTypesList"></div>

            <!-- é™„è¿‘æ™¯é» -->
            <div class="section-title">ğŸ—ºï¸ é™„è¿‘æ™¯é»</div>
            <div id="nearbyAttractionsList"></div>

            <!-- è©•è«–å€ -->
            <div class="section-title">â­ ä½å®¢è©•è«–</div>

            <!-- æ–°å¢è©•è«–è¡¨å–® -->
            <div class="add-review-form" id="addReviewForm" style="display:none;">
                <h5>åˆ†äº«æ‚¨çš„é«”é©—</h5>
                <div class="mb-3">
                    <label class="form-label">è©•åˆ†</label>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-value="1">â˜…</span>
                        <span class="star" data-value="2">â˜…</span>
                        <span class="star" data-value="3">â˜…</span>
                        <span class="star" data-value="4">â˜…</span>
                        <span class="star" data-value="5">â˜…</span>
                    </div>
                    <input type="hidden" id="ratingValue" value="0">
                </div>
                <div class="mb-3">
                    <label for="reviewComment" class="form-label">è©•è«–å…§å®¹</label>
                    <textarea class="form-control" id="reviewComment" rows="4"
                              placeholder="åˆ†äº«æ‚¨çš„ä½å®¿é«”é©—..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitReview()">ç™¼è¡¨è©•è«–</button>
                <button class="btn btn-secondary" onclick="cancelReview()">å–æ¶ˆ</button>
            </div>

            <button class="btn btn-outline-primary mb-3" onclick="showReviewForm()" id="showReviewBtn">
                âœï¸ æ’°å¯«è©•è«–
            </button>

            <!-- è©•è«–åˆ—è¡¨ -->
            <div id="reviewsList"></div>
        </div>

        <!-- å³å´ï¼šè¨‚æˆ¿è³‡è¨Š -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h4>ä½å®¿è³‡è¨Š</h4>
                    <hr>
                    <div class="mb-3">
                        <div class="text-muted">æ¯æ™šåƒ¹æ ¼èµ·</div>
                        <h2 class="text-primary">NT$ <span id="pricePerNight"></span></h2>
                    </div>
                    <button class="btn btn-success w-100 mb-2" onclick="scrollToRoomTypes()">
                        æŸ¥çœ‹æˆ¿å‹èˆ‡åƒ¹æ ¼
                    </button>
                    <button class="btn btn-primary w-100 mb-2" onclick="openQuickBookingModal()">
                        ğŸ¯ ç¾åœ¨å°±é è¨‚
                    </button>
                    <button class="btn btn-outline-danger w-100" onclick="addToFavorites()" id="favoriteBtn">
                        â¤ï¸ åŠ å…¥æ”¶è—
                    </button>

                    <!-- è¯çµ¡è³‡è¨Š -->
                    <div class="contact-info">
                        <h6>ğŸ“ è¯çµ¡è³‡è¨Š</h6>
                        <p class="mb-1">
                            <strong>åœ°å€ï¼š</strong><br>
                            <span id="contactAddress"></span>
                        </p>
                        <p class="mb-0">
                            <strong>é›»è©±ï¼š</strong><br>
                            <span id="contactPhone"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¨‚æˆ¿ç¢ºèª Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ¯ ç¢ºèªè¨‚æˆ¿</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6 id="modalAccommodationName" class="text-primary"></h6>
                    <p class="text-muted" id="modalLocation"></p>
                </div>

                <!-- é¸æ“‡æˆ¿å‹ -->
                <div class="mb-3">
                    <label class="form-label">é¸æ“‡æˆ¿å‹ <span class="text-danger">*</span></label>
                    <select class="form-select" id="modalRoomTypeSelect" onchange="updateBookingPrice()">
                        <option value="">è«‹é¸æ“‡æˆ¿å‹</option>
                    </select>
                    <div class="form-text" id="roomTypeStock"></div>
                </div>

                <!-- æ—¥æœŸé¸æ“‡ -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">å…¥ä½æ—¥æœŸ <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="modalCheckIn"
                               onchange="validateDates(); updateBookingPrice();">
                        <div class="invalid-feedback" id="checkInError"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">é€€æˆ¿æ—¥æœŸ <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="modalCheckOut"
                               onchange="validateDates(); updateBookingPrice();">
                        <div class="invalid-feedback" id="checkOutError"></div>
                    </div>
                </div>

                <!-- æˆ¿é–“æ•¸é‡ -->
                <div class="mb-3">
                    <label class="form-label">æˆ¿é–“æ•¸é‡ <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="modalQuantity"
                           min="1" max="1" value="1"
                           onchange="validateQuantity(); updateBookingPrice();">
                    <div class="form-text">
                        <span id="quantityHint">è«‹å…ˆé¸æ“‡æˆ¿å‹</span>
                    </div>
                    <div class="invalid-feedback" id="quantityError"></div>
                </div>

                <!-- ç¸½åƒ¹é¡¯ç¤º -->
                <div class="alert alert-info">
                    <h5>è¨‚å–®ç¸½è¨ˆ</h5>
                    <div class="d-flex justify-content-between">
                        <span>æˆ¿å‹åƒ¹æ ¼ï¼š</span>
                        <span id="displayRoomPrice">NT$ 0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>ä½å®¿å¤©æ•¸ï¼š</span>
                        <span id="displayNights">0 æ™š</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>æˆ¿é–“æ•¸é‡ï¼š</span>
                        <span id="displayQuantity">1 é–“</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>ç¸½åƒ¹ï¼š</strong>
                        <strong class="text-primary" id="displayTotalPrice">NT$ 0</strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmBooking()">ç¢ºèªè¨‚æˆ¿</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const accommodationId = /*[[${accommodationId}]]*/ 1;
    let accommodationData = null;
    let currentRating = 0;
    let roomTypesData = [];
    let bookingModal = null;

    // ç²å– CSRF token
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    /**
     * æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
     * é€éæª¢æŸ¥å°è¦½åˆ—æ˜¯å¦æœ‰ç™»å…¥æŒ‰éˆ•ä¾†åˆ¤æ–·
     */
    const isUserLoggedIn = () => {
        // æª¢æŸ¥å°è¦½åˆ—æ˜¯å¦æœ‰ã€Œç™»å…¥ã€æŒ‰éˆ•ï¼Œæ²’æœ‰è¡¨ç¤ºå·²ç™»å…¥
        const loginBtn = document.querySelector('a[href="/login"]');
        return !loginBtn;
    };

    // å‰µå»ºå¸¶ CSRF token çš„ fetch é¸é …
    function getFetchOptions(method = 'GET', body = null) {
        const options = {
            method: method,
            headers: {}
        };

        if (csrfToken && csrfHeader) {
            options.headers[csrfHeader] = csrfToken;
        }

        if (body) {
            if (body instanceof FormData) {
                options.body = body;
            } else {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
        }

        return options;
    }

    // è¼‰å…¥ä½å®¿è©³æƒ…
    document.addEventListener('DOMContentLoaded', () => {
        bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        loadAccommodationDetail();
        loadReviews();
        setupStarRating();
        checkIfFavorited(); // æª¢æŸ¥æ˜¯å¦å·²æ”¶è—
        setMinDate(); // è¨­å®šæœ€å°æ—¥æœŸç‚ºä»Šå¤©
    });

    // è¨­å®šæ—¥æœŸæœ€å°å€¼ç‚ºä»Šå¤©
    function setMinDate() {
        const today = new Date().toISOString().split('T')[0];
        const checkInInput = document.getElementById('modalCheckIn');
        const checkOutInput = document.getElementById('modalCheckOut');

        checkInInput.min = today;
        checkOutInput.min = today;

        // è¨­å®šé è¨­å€¼ç‚ºæ˜å¤©å’Œå¾Œå¤©
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const dayAfter = new Date();
        dayAfter.setDate(dayAfter.getDate() + 2);

        checkInInput.value = tomorrow.toISOString().split('T')[0];
        checkOutInput.value = dayAfter.toISOString().split('T')[0];
    }

    // é©—è­‰æ—¥æœŸ
    function validateDates() {
        const checkIn = document.getElementById('modalCheckIn').value;
        const checkOut = document.getElementById('modalCheckOut').value;
        const checkInInput = document.getElementById('modalCheckIn');
        const checkOutInput = document.getElementById('modalCheckOut');
        const checkInError = document.getElementById('checkInError');
        const checkOutError = document.getElementById('checkOutError');

        let isValid = true;

        // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤
        checkInInput.classList.remove('is-invalid');
        checkOutInput.classList.remove('is-invalid');
        checkInError.textContent = '';
        checkOutError.textContent = '';

        if (!checkIn) {
            checkInInput.classList.add('is-invalid');
            checkInError.textContent = 'è«‹é¸æ“‡å…¥ä½æ—¥æœŸ';
            isValid = false;
        }

        if (!checkOut) {
            checkOutInput.classList.add('is-invalid');
            checkOutError.textContent = 'è«‹é¸æ“‡é€€æˆ¿æ—¥æœŸ';
            isValid = false;
        }

        if (checkIn && checkOut) {
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // æª¢æŸ¥å…¥ä½æ—¥æœŸä¸èƒ½æ—©æ–¼ä»Šå¤©
            if (checkInDate < today) {
                checkInInput.classList.add('is-invalid');
                checkInError.textContent = 'å…¥ä½æ—¥æœŸä¸èƒ½æ—©æ–¼ä»Šå¤©';
                isValid = false;
            }

            // æª¢æŸ¥é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ
            if (checkOutDate <= checkInDate) {
                checkOutInput.classList.add('is-invalid');
                checkOutError.textContent = 'é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ';
                isValid = false;
            }

            // è‡ªå‹•èª¿æ•´ï¼šå¦‚æœå…¥ä½æ—¥æœŸè®Šæ›´ï¼Œç¢ºä¿é€€æˆ¿æ—¥æœŸè‡³å°‘æ˜¯éš”å¤©
            if (checkOutDate <= checkInDate) {
                const nextDay = new Date(checkInDate);
                nextDay.setDate(nextDay.getDate() + 1);
                checkOutInput.value = nextDay.toISOString().split('T')[0];
            }

            // æ›´æ–°é€€æˆ¿æ—¥æœŸçš„æœ€å°å€¼ç‚ºå…¥ä½æ—¥æœŸçš„éš”å¤©
            if (checkIn) {
                const minCheckOut = new Date(checkInDate);
                minCheckOut.setDate(minCheckOut.getDate() + 1);
                checkOutInput.min = minCheckOut.toISOString().split('T')[0];
            }
        }

        return isValid;
    }

    // é©—è­‰æˆ¿é–“æ•¸é‡
    function validateQuantity() {
        const select = document.getElementById('modalRoomTypeSelect');
        const quantityInput = document.getElementById('modalQuantity');
        const quantityError = document.getElementById('quantityError');
        const selectedOption = select.options[select.selectedIndex];

        quantityInput.classList.remove('is-invalid');
        quantityError.textContent = '';

        if (!selectedOption.value) {
            return true; // é‚„æ²’é¸æ“‡æˆ¿å‹ï¼Œä¸é©—è­‰
        }

        const maxRooms = parseInt(selectedOption.dataset.totalRooms || 1);
        const quantity = parseInt(quantityInput.value || 1);

        if (quantity < 1) {
            quantityInput.value = 1;
            quantityInput.classList.add('is-invalid');
            quantityError.textContent = 'æˆ¿é–“æ•¸é‡è‡³å°‘ç‚º 1';
            return false;
        }

        if (quantity > maxRooms) {
            quantityInput.value = maxRooms;
            quantityInput.classList.add('is-invalid');
            quantityError.textContent = `æ­¤æˆ¿å‹æœ€å¤šåªæœ‰ ${maxRooms} é–“å¯é è¨‚`;

            // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
            setTimeout(() => {
                quantityInput.classList.remove('is-invalid');
                quantityError.textContent = '';
            }, 3000);

            return false;
        }

        return true;
    }

    function loadAccommodationDetail() {
        fetch(`/api/accommodations/${accommodationId}`)
            .then(r => r.json())
            .then(data => {
                accommodationData = data;
                displayAccommodationDetail(data);
                loadRoomTypes();
            })
            .catch(err => {
                console.error('è¼‰å…¥ä½å®¿è©³æƒ…å¤±æ•—:', err);
                alert('è¼‰å…¥ä½å®¿è©³æƒ…å¤±æ•—');
            });
    }

    function displayAccommodationDetail(acc) {
        // åŸºæœ¬è³‡è¨Š
        document.getElementById('accommodationName').textContent = acc.name;
        document.getElementById('breadcrumb-name').textContent = acc.name;
        document.getElementById('accommodationLocation').textContent = 'ğŸ“ ' + acc.location;
        document.getElementById('accommodationDistance').textContent =
            'ğŸš¶ è·å¸‚ä¸­å¿ƒ ' + (acc.distanceFromCenter || 'æœªçŸ¥') + ' å…¬é‡Œ';
        document.getElementById('accommodationDescription').textContent = acc.description;
        document.getElementById('pricePerNight').textContent = acc.pricePerNight;

        // è©•åˆ†
        if (acc.rating) {
            document.getElementById('ratingBadge').textContent = 'â­ ' + acc.rating;
            document.getElementById('ratingText').textContent =
                `éå¸¸å¥½ï¼ˆ${acc.reviewCount || 0} å‰‡è©•è«–ï¼‰`;
        } else {
            document.getElementById('ratingBadge').textContent = 'æš«ç„¡è©•åˆ†';
            document.getElementById('ratingText').textContent = 'æˆç‚ºç¬¬ä¸€å€‹è©•è«–çš„äºº';
        }

        // åœ–ç‰‡ç•«å»Š
        displayImageGallery(acc);

        // è¨­æ–½
        if (acc.amenities) {
            document.getElementById('amenitiesList').innerHTML = acc.amenities
                .split(',')
                .map(a => `<span class="amenity-item">âœ“ ${a.trim()}</span>`)
                .join('');
        }

        // é™„è¿‘æ™¯é»
        if (acc.nearbyAttractions) {
            document.getElementById('nearbyAttractionsList').innerHTML = acc.nearbyAttractions
                .split(',')
                .map(a => `<div class="nearby-item">ğŸ“ ${a.trim()}</div>`)
                .join('');
        }

        // è¯çµ¡è³‡è¨Š
        document.getElementById('contactAddress').textContent = acc.address || 'æœªæä¾›';
        document.getElementById('contactPhone').textContent = acc.phone || 'æœªæä¾›';
    }

    function displayImageGallery(acc) {
        const gallery = document.getElementById('imageGallery');
        const images = acc.images ? acc.images.split(',') : [];
        const mainImage = acc.imageUrl || images[0] || 'https://picsum.photos/800/600';

        let html = `<div class="main-image">
            <img src="${mainImage}" class="gallery-image" alt="${acc.name}">
        </div>`;

        for (let i = 0; i < Math.min(4, images.length); i++) {
            html += `<div class="side-image">
                <img src="${images[i]}" class="gallery-image" alt="${acc.name}">
            </div>`;
        }

        gallery.innerHTML = html;
    }

    function loadRoomTypes() {
        fetch(`/api/accommodations/${accommodationId}/room-types`)
            .then(r => r.json())
            .then(data => {
                roomTypesData = data; // å„²å­˜æˆ¿å‹è³‡æ–™ä¾› Modal ä½¿ç”¨
                displayRoomTypes(data);
            })
            .catch(err => console.error('è¼‰å…¥æˆ¿å‹å¤±æ•—:', err));
    }

    function displayRoomTypes(roomTypes) {
        const container = document.getElementById('roomTypesList');

        if (!roomTypes || roomTypes.length === 0) {
            container.innerHTML = '<p class="text-muted">ç›®å‰æ²’æœ‰å¯ç”¨çš„æˆ¿å‹</p>';
            return;
        }

        container.innerHTML = roomTypes.map(rt => `
            <div class="room-type-card">
                <div class="row">
                    <div class="col-md-8">
                        <h5>${rt.name}</h5>
                        <p class="text-muted">${rt.description || ''}</p>
                        <div class="text-primary fw-bold">
                            NT$ ${rt.pricePerNight} / æ™š
                        </div>
                        <small class="text-muted">å‰©é¤˜æˆ¿é–“: ${rt.totalRooms} é–“</small>
                    </div>
                    <div class="col-md-4 d-flex align-items-center">
                        <button class="btn btn-primary w-100" onclick="bookRoom(${rt.id}, '${rt.name}')">
                            ç«‹å³é è¨‚
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function loadReviews() {
        fetch(`/api/reviews/accommodation/${accommodationId}`)
            .then(r => r.json())
            .then(data => displayReviews(data))
            .catch(err => console.error('è¼‰å…¥è©•è«–å¤±æ•—:', err));
    }

    function displayReviews(reviews) {
        const container = document.getElementById('reviewsList');

        if (!reviews || reviews.length === 0) {
            container.innerHTML = '<p class="text-muted">ç›®å‰æ²’æœ‰è©•è«–ï¼Œæˆç‚ºç¬¬ä¸€å€‹è©•è«–çš„äººå§ï¼</p>';
            return;
        }

        container.innerHTML = reviews.map(r => `
            <div class="review-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <div class="review-rating">${'â˜…'.repeat(Math.floor(r.rating))}${'â˜†'.repeat(5-Math.floor(r.rating))}</div>
                        <div class="review-author">
                            <strong>${r.userFullName || r.username}</strong>
                        </div>
                    </div>
                    <div class="review-date">${formatDate(r.createdAt)}</div>
                </div>
                <p>${r.comment || ''}</p>
                <div class="review-helpful">
                    ğŸ‘ ${r.helpfulCount || 0} äººè¦ºå¾—æœ‰å¹«åŠ©
                </div>
            </div>
        `).join('');
    }

    function setupStarRating() {
        const stars = document.querySelectorAll('.star-rating .star');
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const value = parseInt(this.dataset.value);
                currentRating = value;
                document.getElementById('ratingValue').value = value;
                updateStarDisplay(value);
            });

            star.addEventListener('mouseenter', function() {
                const value = parseInt(this.dataset.value);
                updateStarDisplay(value);
            });
        });

        document.querySelector('.star-rating').addEventListener('mouseleave', function() {
            updateStarDisplay(currentRating);
        });
    }

    function updateStarDisplay(rating) {
        const stars = document.querySelectorAll('.star-rating .star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }

    function showReviewForm() {
        document.getElementById('addReviewForm').style.display = 'block';
        document.getElementById('showReviewBtn').style.display = 'none';
    }

    function cancelReview() {
        document.getElementById('addReviewForm').style.display = 'none';
        document.getElementById('showReviewBtn').style.display = 'block';
        document.getElementById('reviewComment').value = '';
        currentRating = 0;
        updateStarDisplay(0);
    }

    function submitReview() {
        const rating = currentRating;
        const comment = document.getElementById('reviewComment').value.trim();

        if (rating === 0) {
            alert('è«‹é¸æ“‡è©•åˆ†');
            return;
        }

        if (!comment) {
            alert('è«‹è¼¸å…¥è©•è«–å…§å®¹');
            return;
        }

        fetch(`/api/reviews/accommodation/${accommodationId}?rating=${rating}&comment=${encodeURIComponent(comment)}`,
            getFetchOptions('POST'))
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('è©•è«–ç™¼è¡¨æˆåŠŸï¼');
                cancelReview();
                loadReviews();
                loadAccommodationDetail(); // æ›´æ–°è©•åˆ†
            } else {
                alert(data.message || 'è©•è«–ç™¼è¡¨å¤±æ•—');
            }
        })
        .catch(err => {
            console.error('ç™¼è¡¨è©•è«–å¤±æ•—:', err);
            alert('ç™¼è¡¨è©•è«–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        });
    }

    function bookRoom(roomTypeId, roomTypeName) {
        openQuickBookingModal(roomTypeId);
    }

    // æ‰“é–‹å¿«é€Ÿè¨‚æˆ¿ Modal
    function openQuickBookingModal(preselectedRoomTypeId = null) {
        // è¨­å®šä½å®¿è³‡è¨Š
        document.getElementById('modalAccommodationName').textContent = accommodationData?.name || '';
        document.getElementById('modalLocation').textContent = 'ğŸ“ ' + (accommodationData?.location || '');

        // è¼‰å…¥æˆ¿å‹é¸é …
        const select = document.getElementById('modalRoomTypeSelect');
        select.innerHTML = '<option value="">è«‹é¸æ“‡æˆ¿å‹</option>';

        roomTypesData.forEach(rt => {
            const option = document.createElement('option');
            option.value = rt.id;
            option.textContent = `${rt.name} - NT$ ${rt.pricePerNight} / æ™š (å‰©é¤˜ ${rt.totalRooms} é–“)`;
            option.dataset.price = rt.pricePerNight;
            option.dataset.totalRooms = rt.totalRooms;  // å„²å­˜åº«å­˜æ•¸é‡
            if (preselectedRoomTypeId && rt.id === preselectedRoomTypeId) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        // é‡ç½®è¡¨å–®
        document.getElementById('modalQuantity').value = 1;
        document.getElementById('modalQuantity').max = 1;

        // æ¸…é™¤æ‰€æœ‰éŒ¯èª¤æç¤º
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');

        updateBookingPrice();

        // é¡¯ç¤º Modal
        bookingModal.show();
    }

    // æ›´æ–°è¨‚æˆ¿åƒ¹æ ¼
    function updateBookingPrice() {
        const select = document.getElementById('modalRoomTypeSelect');
        const selectedOption = select.options[select.selectedIndex];
        const roomPrice = parseFloat(selectedOption.dataset.price || 0);
        const totalRooms = parseInt(selectedOption.dataset.totalRooms || 1);

        const quantityInput = document.getElementById('modalQuantity');
        const roomTypeStock = document.getElementById('roomTypeStock');
        const quantityHint = document.getElementById('quantityHint');

        // æ›´æ–°æˆ¿å‹åº«å­˜æç¤º
        if (selectedOption.value) {
            roomTypeStock.textContent = `æ­¤æˆ¿å‹å…±æœ‰ ${totalRooms} é–“å¯é è¨‚`;
            roomTypeStock.className = 'form-text text-success';

            // æ›´æ–°æˆ¿é–“æ•¸é‡ä¸Šé™
            quantityInput.max = totalRooms;
            quantityHint.textContent = `æœ€å¤šå¯é è¨‚ ${totalRooms} é–“`;

            // å¦‚æœç•¶å‰æ•¸é‡è¶…éåº«å­˜ï¼Œè‡ªå‹•èª¿æ•´
            if (parseInt(quantityInput.value) > totalRooms) {
                quantityInput.value = totalRooms;
            }
        } else {
            roomTypeStock.textContent = '';
            quantityInput.max = 1;
            quantityHint.textContent = 'è«‹å…ˆé¸æ“‡æˆ¿å‹';
        }

        const checkIn = document.getElementById('modalCheckIn').value;
        const checkOut = document.getElementById('modalCheckOut').value;
        const quantity = parseInt(quantityInput.value) || 1;

        // è¨ˆç®—ä½å®¿å¤©æ•¸
        let nights = 0;
        if (checkIn && checkOut) {
            const start = new Date(checkIn);
            const end = new Date(checkOut);
            nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            if (nights < 0) nights = 0;
        }

        // æ›´æ–°é¡¯ç¤º
        document.getElementById('displayRoomPrice').textContent = `NT$ ${roomPrice.toLocaleString()}`;
        document.getElementById('displayNights').textContent = `${nights} æ™š`;
        document.getElementById('displayQuantity').textContent = `${quantity} é–“`;

        const totalPrice = roomPrice * nights * quantity;
        document.getElementById('displayTotalPrice').textContent = `NT$ ${totalPrice.toLocaleString()}`;
    }

    // ç¢ºèªè¨‚æˆ¿
    function confirmBooking() {
        // æª¢æŸ¥æ˜¯å¦ç™»å…¥
        if (!isUserLoggedIn()) {
            if (confirm('é è¨‚åŠŸèƒ½éœ€è¦ç™»å…¥ï¼Œæ˜¯å¦å‰å¾€ç™»å…¥ï¼Ÿ')) {
                // ä¿å­˜ç•¶å‰é é¢ URL
                sessionStorage.setItem('redirectUrl', window.location.href);
                window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
            }
            return;
        }

        const roomTypeId = document.getElementById('modalRoomTypeSelect').value;
        const checkIn = document.getElementById('modalCheckIn').value;
        const checkOut = document.getElementById('modalCheckOut').value;
        const quantity = parseInt(document.getElementById('modalQuantity').value) || 1;
        const select = document.getElementById('modalRoomTypeSelect');
        const selectedOption = select.options[select.selectedIndex];
        const maxRooms = parseInt(selectedOption.dataset.totalRooms || 1);

        // é©—è­‰æˆ¿å‹
        if (!roomTypeId) {
            alert('âŒ è«‹é¸æ“‡æˆ¿å‹');
            return;
        }

        // é©—è­‰æ—¥æœŸ
        if (!checkIn || !checkOut) {
            alert('âŒ è«‹é¸æ“‡å…¥ä½å’Œé€€æˆ¿æ—¥æœŸ');
            return;
        }

        // é©—è­‰æ—¥æœŸé‚è¼¯
        if (!validateDates()) {
            alert('âŒ è«‹æª¢æŸ¥æ—¥æœŸæ˜¯å¦æ­£ç¢º');
            return;
        }

        const start = new Date(checkIn);
        const end = new Date(checkOut);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (start < today) {
            alert('âŒ å…¥ä½æ—¥æœŸä¸èƒ½æ—©æ–¼ä»Šå¤©');
            return;
        }

        if (end <= start) {
            alert('âŒ é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ');
            return;
        }

        // é©—è­‰æˆ¿é–“æ•¸é‡
        if (quantity < 1) {
            alert('âŒ æˆ¿é–“æ•¸é‡è‡³å°‘ç‚º 1');
            return;
        }

        if (quantity > maxRooms) {
            alert(`âŒ æ­¤æˆ¿å‹æœ€å¤šåªæœ‰ ${maxRooms} é–“å¯é è¨‚\næ‚¨é¸æ“‡äº† ${quantity} é–“ï¼Œè«‹èª¿æ•´æ•¸é‡`);
            return;
        }

        // ç™¼é€è¨‚æˆ¿è«‹æ±‚
        const formData = new FormData();
        formData.append('roomTypeId', roomTypeId);
        formData.append('checkIn', checkIn);
        formData.append('checkOut', checkOut);
        formData.append('quantity', quantity);

        fetch('/api/bookings/book-by-room-type', getFetchOptions('POST', formData))
        .then(r => {
            // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
            if (r.status === 401 || r.status === 403) {
                // æœªæˆæ¬Šæˆ–ç¦æ­¢è¨ªå•ï¼Œå°å‘ç™»å…¥
                if (confirm('æ‚¨å°šæœªç™»å…¥æˆ–ç™»å…¥å·²éæœŸï¼Œæ˜¯å¦å‰å¾€ç™»å…¥ï¼Ÿ')) {
                    sessionStorage.setItem('redirectUrl', window.location.href);
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                }
                throw new Error('æœªæˆæ¬Š');
            }
            return r.json();
        })
        .then(data => {
            if (data.success) {
                alert('âœ… è¨‚æˆ¿æˆåŠŸï¼\nè¨‚å–®ç·¨è™Ÿï¼š' + data.bookingId);
                bookingModal.hide();
                // å¯ä»¥è·³è½‰åˆ°è¨‚å–®é é¢
                if (confirm('æ˜¯å¦å‰å¾€æŸ¥çœ‹è¨‚å–®ï¼Ÿ')) {
                    window.location.href = '/user-bookings';
                }
            } else {
                alert('âŒ è¨‚æˆ¿å¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
            }
        })
        .catch(err => {
            console.error('è¨‚æˆ¿å¤±æ•—:', err);
            // å¦‚æœä¸æ˜¯æœªæˆæ¬ŠéŒ¯èª¤æ‰é¡¯ç¤ºä¸€èˆ¬éŒ¯èª¤è¨Šæ¯
            if (err.message !== 'æœªæˆæ¬Š') {
                alert('âŒ è¨‚æˆ¿å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        });
    }

    function scrollToRoomTypes() {
        document.getElementById('roomTypesList').scrollIntoView({ behavior: 'smooth' });
    }

    function addToFavorites() {
        fetch(`/user/favorites/api/add/${accommodationId}`, getFetchOptions('POST'))
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('âœ… å·²åŠ å…¥æ”¶è—ï¼');
                // æ›´æ–°æŒ‰éˆ•æ¨£å¼
                const btn = document.getElementById('favoriteBtn');
                btn.classList.remove('btn-outline-danger');
                btn.classList.add('btn-danger');
                btn.innerHTML = 'ğŸ’– å·²æ”¶è—';
                btn.disabled = true;
            } else {
                alert(data.message || 'åŠ å…¥æ”¶è—å¤±æ•—');
            }
        })
        .catch(err => {
            console.error('åŠ å…¥æ”¶è—å¤±æ•—:', err);
            alert('è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨æ”¶è—åŠŸèƒ½');
        });
    }

    // æª¢æŸ¥æ˜¯å¦å·²æ”¶è—
    function checkIfFavorited() {
        fetch(`/user/favorites/api/check/${accommodationId}`)
            .then(r => r.json())
            .then(data => {
                if (data.favorited) {
                    const btn = document.getElementById('favoriteBtn');
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');
                    btn.innerHTML = 'ğŸ’– å·²æ”¶è—';
                    btn.disabled = true;
                }
            })
            .catch(err => console.log('æœªç™»å…¥æˆ–æª¢æŸ¥æ”¶è—å¤±æ•—'));
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
    }
</script>

</body>
</html>

